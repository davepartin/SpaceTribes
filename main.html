<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Space Tribes: Command & Decisions</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 50%, #2d1b69 100%);
      color: #ffffff;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      padding: 20px;
      font-size: 1.1rem;
    }
    
    h1 {
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      font-size: 3rem;
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    .logo-container {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .game-logo {
      max-width: 400px;
      width: 100%;
      height: auto;
      filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.3));
      animation: logoGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes logoGlow {
      from { filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.3)); }
      to { filter: drop-shadow(0 0 30px rgba(255, 0, 255, 0.5)); }
    }
    
    @keyframes glow {
      from { text-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
      to { text-shadow: 0 0 30px rgba(255, 0, 255, 0.5); }
    }
    
    h2 {
      font-family: 'Orbitron', monospace;
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #ffff00;
    }
    
    h3 {
      font-size: 1.3rem;
      color: #00ffff;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .player-header {
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 1.2rem;
    }
    
    .tribe-header {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      color: #00ffff;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #playerIcon {
      font-size: 3rem;
      margin-right: 15px;
      filter: drop-shadow(0 0 15px currentColor);
    }
    
    .game-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      .game-grid {
        grid-template-columns: 1fr;
      }
      
      /* Mobile optimizations for iPhone */
      body {
        padding: 10px;
        font-size: 1rem;
      }
      
      h1 {
        font-size: 2rem;
        margin-bottom: 15px;
      }
      
      .game-logo {
        max-width: 280px;
      }
      
      .tribe-header {
        font-size: 1.5rem;
        padding: 10px;
      }
      
      #playerIcon {
        font-size: 2rem;
        margin-right: 10px;
      }
      
      .player-header {
        padding: 10px;
        font-size: 1rem;
      }
      
      .material-row {
        padding: 10px 15px;
        margin: 8px 0;
      }
      
      .material-icon {
        font-size: 1.5rem;
        margin-right: 8px;
      }
      
      .sell-controls {
        gap: 6px;
      }
      
      .sell-controls button {
        width: 32px;
        height: 32px;
        font-size: 1.3rem;
      }
      
      .count-display {
        padding: 6px 10px;
        font-size: 1rem;
        min-width: 40px;
      }
      
      section, .decision-section {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
      }
      
      .submit-btn {
        padding: 12px 20px;
        font-size: 1rem;
        margin: 5px;
      }
      
      .player-status-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
      }
      
      .player-status {
        padding: 6px 8px;
        font-size: 0.8rem;
      }
      
      table {
        font-size: 0.9rem;
      }
      
      th, td {
        padding: 6px 8px;
      }
    }
    
    section, .decision-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .robot-fleet {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .robots-container {
      display: flex;
      justify-content: center;
      flex-wrap: nowrap;
      gap: 4px;
      margin: 15px 0;
    }
    
    .robot {
      font-size: 1.5rem;
      transition: all 0.3s ease;
      cursor: default;
      filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.5));
    }
    
    .robot.assigned {
      filter: grayscale(100%) brightness(0.3);
      transform: scale(0.8);
    }
    
    .robot.available {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .material-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .material-row:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }
    
    .material-icon {
      font-size: 1.8rem;
      filter: drop-shadow(0 0 10px currentColor);
      margin-right: 10px;
    }
    
    .material-info {
      display: flex;
      align-items: center;
      flex: 1;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
    }
    
    .sell-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sell-controls button {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      font-size: 1.6rem;
      font-weight: bold;
      background: linear-gradient(135deg, #00ffff, #00ccff);
      color: #222;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    
    .sell-controls button:hover {
      background: linear-gradient(135deg, #ff00ff, #00ffff);
      color: #fff;
    }
    
    .sell-controls button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    .count-display {
      background: rgba(0, 255, 255, 0.2);
      border: 2px solid rgba(0, 255, 255, 0.5);
      border-radius: 8px;
      padding: 8px 15px;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      font-size: 1.2rem;
      color: #00ffff;
      min-width: 50px;
      text-align: center;
    }
    
    .message {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1rem;
    }
    
    .message.success {
      background: rgba(0, 255, 0, 0.1);
      border: 2px solid rgba(0, 255, 0, 0.3);
      color: #00ff00;
    }
    
    .message.error {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid rgba(255, 0, 0, 0.3);
      color: #ff6666;
    }
    
    .fade-in {
      animation: fadeIn 1s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    th {
      background: rgba(255, 255, 255, 0.1);
      color: #00ffff;
      font-family: 'Orbitron', monospace;
    }
    
    ul {
      list-style: none;
      padding: 0;
    }
    
    li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .raid-section {
      background: rgba(255, 0, 0, 0.05);
      border: 2px solid rgba(255, 0, 0, 0.3);
    }

    /* Player Status Dashboard Styles */
    .players-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .player-status-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .player-status-card:hover {
      transform: translateY(-3px);
      border-color: rgba(0, 255, 255, 0.5);
      box-shadow: 0 8px 25px rgba(0, 255, 255, 0.2);
    }

    .player-status-card.active {
      border-color: #00ff00;
      background: rgba(0, 255, 0, 0.1);
    }

    .player-status-card.waiting {
      border-color: #ffff00;
      background: rgba(255, 255, 0, 0.1);
    }

    .player-status-card.inactive {
      border-color: #ff6666;
      background: rgba(255, 0, 0, 0.1);
    }

    .player-header-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .player-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #00ffff;
    }

    .player-race {
      font-size: 0.9rem;
      color: #cccccc;
      font-style: italic;
    }

    .player-status {
      font-size: 1.1rem;
      font-weight: bold;
      padding: 5px 12px;
      border-radius: 20px;
      text-align: center;
    }

    .player-status.active {
      background: rgba(0, 255, 0, 0.2);
      color: #00ff00;
      border: 1px solid #00ff00;
    }

    .player-status.waiting {
      background: rgba(255, 255, 0, 0.2);
      color: #ffff00;
      border: 1px solid #ffff00;
    }

    .player-status.inactive {
      background: rgba(255, 0, 0, 0.2);
      color: #ff6666;
      border: 1px solid #ff6666;
    }

    .player-details {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .stat-label {
      color: #cccccc;
      min-width: 60px;
    }

    .stat-value {
      color: #00ffff;
      font-weight: bold;
    }

    .player-activity {
      font-size: 0.9rem;
      color: #ffff00;
      text-align: center;
      padding: 8px;
      background: rgba(255, 255, 0, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 0, 0.3);
    }

    .loading-status {
      text-align: center;
      color: #cccccc;
      font-style: italic;
      padding: 20px;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #00ffff, #00ccff);
      color: #222;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
    }

    .refresh-btn:hover {
      background: linear-gradient(135deg, #ff00ff, #00ffff);
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 255, 255, 0.4);
    }
    
    select, .raid-target {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-family: 'Space Mono', monospace;
      margin: 10px 0;
    }
    
    .radio-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }
    
    .radio-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
        /* New styles for game structure */
        .game-status-header {
          background: rgba(255, 255, 0, 0.1);
          border: 2px solid rgba(255, 255, 0, 0.3);
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          font-family: 'Orbitron', monospace;
      text-align: center;
        }

        .status-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 5px 0;
          font-size: 1.1rem;
        }

        .winner-announcement {
          font-size: 2rem;
      color: #ffff00;
          text-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
          margin-bottom: 10px;
          animation: glow 2s ease-in-out infinite alternate;
        }

        .winner-credits {
          font-size: 1.2rem;
          color: #00ff00;
        }

        .modal {
          position: fixed;
          top: 0;
          left: 0;
      width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.9);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .modal-content {
          background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 50%, #2d1b69 100%);
          border: 3px solid rgba(255, 255, 0, 0.5);
          border-radius: 20px;
          padding: 30px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          text-align: center;
          box-shadow: 0 0 50px rgba(255, 255, 0, 0.3);
        }

        .modal-header h2 {
          color: #ffff00;
      font-family: 'Orbitron', monospace;
          font-size: 1.8rem;
          margin-bottom: 20px;
          text-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
        }

        .winner-showcase {
          background: rgba(255, 255, 0, 0.1);
          border: 2px solid rgba(255, 255, 0, 0.3);
          border-radius: 15px;
          padding: 20px;
          margin: 20px 0;
        }

        .winner-title {
          font-size: 1rem;
          color: #ffff00;
          margin-bottom: 10px;
          font-family: 'Orbitron', monospace;
        }

        .winner-name {
          font-size: 2.5rem;
          color: #ffffff;
          font-family: 'Orbitron', monospace;
          font-weight: 900;
          margin-bottom: 10px;
          text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }

        .winner-score {
          font-size: 1.5rem;
      color: #00ff00;
          font-weight: bold;
        }

        .final-standings {
          margin: 20px 0;
        }

        .final-standings h3 {
          color: #00ffff;
          margin-bottom: 15px;
        }

        .final-standings-table {
          background: rgba(255, 255, 255, 0.05);
          border-radius: 10px;
          padding: 15px;
        }

        .standings-row {
      display: flex;
          justify-content: space-between;
      align-items: center;
          padding: 8px 15px;
          margin: 5px 0;
          border-radius: 8px;
          font-family: 'Space Mono', monospace;
        }

        .standings-row.first {
          background: rgba(255, 215, 0, 0.2);
          border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .standings-row.second {
          background: rgba(192, 192, 192, 0.2);
          border: 1px solid rgba(192, 192, 192, 0.5);
        }

        .standings-row.third {
          background: rgba(205, 127, 50, 0.2);
          border: 1px solid rgba(205, 127, 50, 0.5);
        }

        .game-summary {
          margin: 20px 0;
      font-size: 0.9rem;
          color: #ccc;
          line-height: 1.6;
        }

        .modal-footer {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 30px;
        }

        .modal-btn {
          padding: 12px 25px;
          font-size: 1rem;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      border: none;
          border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
        }

        .new-game-btn {
          background: linear-gradient(135deg, #00ff00, #00cc00);
          color: #000;
        }

        .close-btn {
          background: linear-gradient(135deg, #666, #888);
      color: #fff;
    }

        .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

        .auto-advance-notification {
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #ff8800, #cc6600);
          border: 2px solid rgba(255, 136, 0, 0.8);
          border-radius: 10px;
          padding: 15px;
          max-width: 400px;
          z-index: 999;
          animation: slideIn 0.5s ease-out;
        }

        .notification-content {
          display: flex;
          align-items: center;
          gap: 10px;
          font-family: 'Orbitron', monospace;
          font-size: 0.9rem;
        }

        .notification-icon {
          font-size: 1.5rem;
        }

        .notification-btn {
      padding: 6px 12px;
      font-size: 0.8rem;
          font-family: 'Orbitron', monospace;
          font-weight: bold;
          border: none;
          border-radius: 5px;
          background: linear-gradient(135deg, #00ff00, #00cc00);
          color: #000;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .notification-btn:hover {
          transform: scale(1.05);
        }

        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
          .status-row {
            flex-direction: column;
            gap: 5px;
          }
          
          .modal-content {
            padding: 20px;
            margin: 10px;
          }
          
          .winner-name {
            font-size: 2rem;
          }
          
          .auto-advance-notification {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            max-width: none;
          }
          
          .notification-content {
            flex-direction: column;
      text-align: center;
            gap: 8px;
          }
        }

        /* New styles for dump section */
        .dump-section {
          background: rgba(255, 165, 0, 0.05);
          border: 2px solid rgba(255, 165, 0, 0.3);
          margin-bottom: 25px;
        }

        .dump-section h2 {
          color: #ffaa00;
        }

        .dump-available, .dump-used {
          padding: 15px;
        }

        .dump-status {
      display: flex;
      align-items: center;
          gap: 10px;
          margin-bottom: 15px;
          font-size: 1.1rem;
          font-weight: bold;
        }

        .dump-status.used {
          color: #00ff00;
        }

        .dump-icon {
          font-size: 1.5rem;
          filter: drop-shadow(0 0 10px currentColor);
        }

        .dump-controls {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin-bottom: 20px;
        }

        .dump-dropdown, .dump-amount {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .dump-dropdown label, .dump-amount label {
          font-weight: bold;
          color: #ffaa00;
        }

        .dump-dropdown select {
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 165, 0, 0.3);
      border-radius: 8px;
          padding: 10px;
          color: white;
          font-family: 'Space Mono', monospace;
          font-size: 1rem;
        }

        .dump-amount-controls {
      display: flex;
      align-items: center;
          gap: 10px;
        }

        .dump-amount-controls button {
          width: 35px;
          height: 35px;
          border-radius: 50%;
          border: none;
          font-size: 1.4rem;
      font-weight: bold;
          background: linear-gradient(135deg, #ffaa00, #ff8800);
          color: #000;
          cursor: pointer;
          transition: all 0.2s;
        }

        .dump-amount-controls button:hover {
          background: linear-gradient(135deg, #ff8800, #ffaa00);
          transform: scale(1.1);
        }

        .dump-amount-controls button:disabled {
          background: #444;
          color: #888;
          cursor: not-allowed;
          transform: none;
        }

        .dump-preview {
          margin-top: 8px;
          padding: 8px 12px;
          background: rgba(0, 255, 0, 0.1);
          border: 1px solid rgba(0, 255, 0, 0.3);
          border-radius: 5px;
          font-weight: bold;
          color: #00ff00;
          text-align: center;
        }

        .dump-actions {
          text-align: center;
        }

        .dump-btn {
          padding: 12px 25px;
          font-size: 1.1rem;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
          background: linear-gradient(135deg, #ffaa00, #ff8800);
          color: #000;
    }

        .dump-btn:hover:not(:disabled) {
      transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(255, 165, 0, 0.3);
          background: linear-gradient(135deg, #ff8800, #ffaa00);
    }

        .dump-btn:disabled {
          background: #555;
      color: #999;
      cursor: not-allowed;
      transform: none;
    }

        /* New styles for structured news */
        .news-controls {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          align-items: center;
          flex-wrap: wrap;
        }

        .news-toggle {
          padding: 8px 15px;
          font-size: 0.9rem;
          font-family: 'Orbitron', monospace;
          border: 2px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          background: rgba(255, 255, 255, 0.05);
          color: #ccc;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .news-toggle.active {
          background: rgba(0, 255, 255, 0.2);
          border-color: rgba(0, 255, 255, 0.5);
          color: #00ffff;
        }

        .news-toggle:hover {
          background: rgba(255, 255, 255, 0.1);
          transform: translateY(-1px);
        }

        #newsFilter {
          padding: 8px 12px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          color: white;
          font-family: 'Space Mono', monospace;
          font-size: 0.9rem;
        }

        .news-day-section {
          margin-bottom: 25px;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          overflow: hidden;
          background: rgba(255, 255, 255, 0.02);
        }

        .news-day-header {
          background: rgba(0, 255, 255, 0.1);
          border-bottom: 1px solid rgba(0, 255, 255, 0.3);
          padding: 12px 20px;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-family: 'Orbitron', monospace;
      font-weight: bold;
          color: #00ffff;
          transition: all 0.3s ease;
        }

        .news-day-header:hover {
          background: rgba(0, 255, 255, 0.15);
        }

        .news-day-header.collapsed {
          border-bottom: none;
        }

        .day-title {
          font-size: 1.1rem;
        }

        .day-stats {
          font-size: 0.8rem;
          color: #aaa;
      display: flex;
          gap: 15px;
        }

        .collapse-icon {
          font-size: 1.2rem;
          transition: transform 0.3s ease;
        }

        .collapse-icon.collapsed {
          transform: rotate(-90deg);
        }

        .news-day-content {
          padding: 15px;
      display: block;
        }

        .news-day-content.collapsed {
          display: none;
        }

        .news-category {
          margin-bottom: 20px;
        }

        .news-category:last-child {
          margin-bottom: 0;
        }

        .news-category-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 10px;
          font-family: 'Orbitron', monospace;
      font-weight: bold;
          font-size: 0.95rem;
        }

        .category-icon {
          font-size: 1.1rem;
          filter: drop-shadow(0 0 8px currentColor);
        }

        .category-raid .category-icon { color: #ff6666; }
        .category-mining .category-icon { color: #66ff66; }
        .category-market .category-icon { color: #ffaa00; }
        .category-general .category-icon { color: #66ccff; }

        .news-items {
          list-style: none;
          padding: 0;
          margin: 0;
        }

        .news-item {
          padding: 8px 15px;
          margin: 5px 0;
          border-radius: 6px;
          font-size: 0.9rem;
          line-height: 1.4;
          border-left: 3px solid;
          background: rgba(255, 255, 255, 0.03);
          transition: all 0.2s ease;
        }

        .news-item:hover {
          background: rgba(255, 255, 255, 0.08);
          transform: translateX(5px);
        }

        .news-item.priority-3 {
          font-weight: bold;
          background: rgba(255, 255, 0, 0.05);
        }

        .news-item.priority-2 {
          font-weight: 500;
        }

        .news-item.raid { border-left-color: #ff6666; }
        .news-item.mining { border-left-color: #66ff66; }
        .news-item.market { border-left-color: #ffaa00; }
        .news-item.general { border-left-color: #66ccff; }

        .no-news {
          text-align: center;
          color: #666;
          font-style: italic;
          padding: 20px;
        }

        .news-summary {
          background: rgba(255, 255, 255, 0.05);
          border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
          padding: 10px 15px;
          margin-bottom: 15px;
          font-size: 0.85rem;
          color: #ccc;
        }

        .summary-stats {
          display: flex;
          justify-content: space-between;
          gap: 10px;
        }

        .stat-item {
          display: flex;
          align-items: center;
          gap: 5px;
        }

        @media (max-width: 768px) {
          .news-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
          }
          
          .news-toggle {
      padding: 10px;
      font-size: 1rem;
    }

          .day-stats {
            flex-direction: column;
            gap: 5px;
            align-items: flex-end;
          }
          
          .news-day-header {
            padding: 10px 15px;
          }
          
          .summary-stats {
            flex-direction: column;
            gap: 5px;
          }
          
          .news-item {
            padding: 6px 12px;
            font-size: 0.85rem;
          }
        }

        /* ADDED STYLES */
        .button-group {
          text-align: center;
          margin: 30px 0;
        }

        .submit-btn, .process-btn {
          padding: 15px 30px;
          font-size: 1.2rem;
      font-family: 'Orbitron', monospace;
          font-weight: bold;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          transition: all 0.3s ease;
          margin: 10px;
          display: inline-block;
        }

        .submit-btn {
          background: linear-gradient(135deg, #00ff00, #00cc00);
          color: #000;
          min-width: 300px;
        }

        .process-btn {
          background: linear-gradient(135deg, #ff8800, #cc6600);
          color: #fff;
        }

        .submit-btn:hover, .process-btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .submit-btn:disabled {
          background: linear-gradient(135deg, #666, #888);
          color: #ccc;
          cursor: not-allowed;
          transform: none;
        }

        .admin-section {
      text-align: center;
          margin: 30px 0;
          padding: 20px;
          border-top: 2px solid rgba(255, 255, 255, 0.1);
          display: block; /* Show by default for debugging */
        }

        .admin-buttons {
          display: flex;
          justify-content: center;
          gap: 15px;
          align-items: center;
          flex-wrap: wrap;
        }

        .admin-btn {
          padding: 12px 20px;
          font-size: 1rem;
          font-family: 'Orbitron', monospace;
          font-weight: bold;
          border: none;
      border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: linear-gradient(135deg, #ff4444, #cc0000);
          color: #fff;
        }

        .admin-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .reset-btn {
          background: linear-gradient(135deg, #ff8800, #cc4400);
          padding: 10px 18px;
      font-size: 0.9rem;
        }

        /* Remove any conflicting .submit-button styles */
        .submit-button {
          display: none !important; /* Hide old buttons */
        }

        @media (max-width: 768px) {
          .submit-btn {
            padding: 12px 20px;
            font-size: 1rem;
            margin: 5px;
            min-width: 250px;
          }
          
          .admin-buttons {
            flex-direction: column;
            gap: 10px;
          }
        }
  </style>
</head>
<body>
  <div class="container fade-in">
    <div class="logo-container">
      <img src="spacetribeslogo2.png" alt="Space Tribes" class="game-logo">
    </div>
    <div class="tribe-header">
      <span id="playerIcon">🐻</span>
      <span id="tribeName">Tribe of Endor</span>
    </div>

    <div class="player-header">
            <div>Day <span id="currentDay">?</span> | Player: <span id="playerCommander">Loading...</span> | Credits: $<span id="playerCredits">0</span></div>
            <div style="margin-top: 10px;">Tribe: <span id="playerRace">Loading...</span> | Available Robots: <span id="robotCount">12</span>/12</div>
    </div>

        <!-- 1. Game Status Header (add after player-header) -->
        <div class="game-status-header" id="gameStatusHeader">
          <div id="activeGameStatus">
            <div class="status-row">
              <span>📅 Day <span id="statusCurrentDay">?</span> of 10</span>
              <span>⏰ <span id="daysRemaining">?</span> days remaining</span>
            </div>
            <div class="status-row">
              <span>👥 <span id="submittedCount">0</span>/<span id="activePlayerCount">0</span> players submitted</span>
              <span id="autoAdvanceStatus">⏳ Waiting for submissions...</span>
      </div>
    </div>

          <div id="gameEndedStatus" style="display: none;">
            <div class="winner-announcement">
              🏆 <span id="winnerName">Game Complete!</span> 🏆
            </div>
            <div class="winner-credits">
              Final Score: $<span id="winnerCredits">0</span>
            </div>
          </div>
        </div>

        <!-- Player Status Dashboard -->
        <div class="decision-section">
          <h2>👥 Player Status Dashboard - Day <span id="dashboardDay">?</span></h2>
          <p>Real-time status of all 6 players. Green = Active, Yellow = Waiting, Red = Inactive</p>
          
          <div style="text-align: center; margin-bottom: 20px;">
            <button onclick="loadPlayerStatus()" class="refresh-btn">🔄 Refresh Player Status</button>
          </div>
          
          <div class="players-dashboard" id="playersDashboard">
            <!-- Player status buttons will be inserted here by JavaScript -->
            <div class="loading-status">Loading player status...</div>
          </div>
        </div>

        <div class="decision-section">
            <h2>📊 Current Market Prices</h2>
          <table>
              <thead>
                <tr>
                  <th>Resource</th>
                        <th>Price per unit</th>
                </tr>
              </thead>
                <tbody>
                    <tr><td>💎 White Diamonds</td><td>$<span id="price-whiteDiamonds">?</span></td></tr>
                    <tr><td>🔻 Red Rubies</td><td>$<span id="price-redRubies">?</span></td></tr>
                    <tr><td>🔷 Blue Gems</td><td>$<span id="price-blueGems">?</span></td></tr>
                    <tr><td>🌱 Green Poison</td><td>$<span id="price-greenPoison">?</span></td></tr>
              </tbody>
            </table>
          </div>

        <div class="decision-section">
            <h2>📦 Your Stockpiles</h2>
          <table>
            <thead>
                    <tr>
                        <th>Resource</th>
                        <th>Available</th>
                        <th>Protected</th>
                        <th>Total</th>
                    </tr>
            </thead>
                <tbody id="stockpile">
                    <!-- Stockpile data will be inserted here by JavaScript -->
                </tbody>
          </table>
    </div>

        <!-- Selling Decisions (FIRST - MORNING) -->
    <div class="decision-section">
          <h2>💰 Sell Resources - Day <span id="sellDayNumber">?</span> Morning</h2>
          <p>Base prices ($20💎, $15🔻, $12🔷, $10🌱) show relative resource values. Actual selling prices determined by total market sales vs colony demand.</p>
      
      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">💎</span>
              <div>
                <div><strong>Day <span id="sell-day-whiteDiamonds">?</span> Colony Needs: <span id="sell-need-whiteDiamonds" style="color: #ffff00;">15</span></strong> | Base Value: $20</div>
                <div>Current Stockpiles: <span id="stockpiles-whiteDiamonds">Loading...</span></div>
                <div>Total Available: <span id="total-available-whiteDiamonds">0</span></div>
              </div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustSell('whiteDiamonds', -1)">➖</button>
              <span class="count-display" id="sellCount-whiteDiamonds">0</span>
              <button type="button" onclick="adjustSell('whiteDiamonds', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔻</span>
              <div>
                <div><strong>Day <span id="sell-day-redRubies">?</span> Colony Needs: <span id="sell-need-redRubies" style="color: #ffff00;">15</span></strong> | Base Value: $15</div>
                <div>Current Stockpiles: <span id="stockpiles-redRubies">Loading...</span></div>
                <div>Total Available: <span id="total-available-redRubies">0</span></div>
              </div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustSell('redRubies', -1)">➖</button>
              <span class="count-display" id="sellCount-redRubies">0</span>
              <button type="button" onclick="adjustSell('redRubies', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔷</span>
              <div>
                <div><strong>Day <span id="sell-day-blueGems">?</span> Colony Needs: <span id="sell-need-blueGems" style="color: #ffff00;">15</span></strong> | Base Value: $12</div>
                <div>Current Stockpiles: <span id="stockpiles-blueGems">Loading...</span></div>
                <div>Total Available: <span id="total-available-blueGems">0</span></div>
              </div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustSell('blueGems', -1)">➖</button>
              <span class="count-display" id="sellCount-blueGems">0</span>
              <button type="button" onclick="adjustSell('blueGems', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🌱</span>
              <div>
                <div><strong>Day <span id="sell-day-greenPoison">?</span> Colony Needs: <span id="sell-need-greenPoison" style="color: #ffff00;">15</span></strong> | Base Value: $10</div>
                <div>Current Stockpiles: <span id="stockpiles-greenPoison">Loading...</span></div>
                <div>Total Available: <span id="total-available-greenPoison">0</span></div>
              </div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustSell('greenPoison', -1)">➖</button>
              <span class="count-display" id="sellCount-greenPoison">0</span>
              <button type="button" onclick="adjustSell('greenPoison', 1)">➕</button>
        </div>
      </div>
    </div>

        <!-- Emergency Dump Section (AFTER Selling, BEFORE Mining) -->
        <div class="decision-section dump-section">
          <h2>💰 Emergency Dump Safety Net</h2>
          <p>Dump ONE resource type per day at guaranteed $10/unit. Use when market prices crash or you need emergency credits!</p>
          
          <div id="dumpAvailable" class="dump-available">
            <div class="dump-info">
              <div class="dump-status">
                <span class="dump-icon">🛡️</span>
                <span>Safety net available - choose wisely!</span>
              </div>
            </div>
            
            <div class="dump-controls">
              <div class="dump-dropdown">
                <label>Choose Resource to Dump:</label>
                <select id="dumpResource">
                  <option value="none">Select Resource...</option>
                  <option value="whiteDiamonds">💎 White Diamonds</option>
                  <option value="redRubies">🔻 Red Rubies</option>
                  <option value="blueGems">🔷 Blue Gems</option>
                  <option value="greenPoison">🌱 Green Poison</option>
                </select>
              </div>
              
              <div class="dump-amount" id="dumpAmountSection" style="display: none;">
                <label>Amount to Dump (Max 15):</label>
                <div class="dump-amount-controls">
                  <button type="button" onclick="adjustDump(-1)">➖</button>
                  <span class="count-display" id="dumpAmount">1</span>
                  <button type="button" onclick="adjustDump(1)">➕</button>
                </div>
                <div class="dump-preview">
                  <span>Guaranteed Earnings: $<span id="dumpEarnings">10</span></span>
                </div>
              </div>
            </div>
            
            <div class="dump-actions">
              <button class="dump-btn" id="dumpBtn" onclick="submitDump()" disabled>
                💰 EMERGENCY DUMP
              </button>
            </div>
          </div>
          
          <div id="dumpUsed" class="dump-used" style="display: none;">
            <div class="dump-status used">
              <span class="dump-icon">✅</span>
              <span>Safety net used today: <span id="dumpUsedResource">None</span></span>
              <div class="dump-used-details">
                Earned $<span id="dumpUsedEarnings">0</span> from emergency dump
              </div>
            </div>
          </div>
        </div>

        <!-- Mining Decisions (SECOND - EVENING) -->
    <div class="decision-section">
          <h2>⛏️ Deploy Robots for Day <span id="miningDayNumber">?</span></h2>
          <p>Assign your 12 mining robots to extract resources for tomorrow. Each robot mines 1 unit per turn.</p>
          
          <!-- Compact Robot Display -->
          <div class="robots-container" id="robotsContainer"></div>
      
      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">💎</span>
              <div><strong>Day <span id="mining-day-whiteDiamonds">?</span> Colony Needs: <span id="mining-need-whiteDiamonds" style="color: #ffff00;">15</span></strong> | Base Value: $20</div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustEffort('whiteDiamonds', -1)">➖</button>
              <span class="count-display" id="effortCount-whiteDiamonds">0</span>
              <button type="button" onclick="adjustEffort('whiteDiamonds', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔻</span>
              <div><strong>Day <span id="mining-day-redRubies">?</span> Colony Needs: <span id="mining-need-redRubies" style="color: #ffff00;">15</span></strong> | Base Value: $15</div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustEffort('redRubies', -1)">➖</button>
              <span class="count-display" id="effortCount-redRubies">0</span>
              <button type="button" onclick="adjustEffort('redRubies', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔷</span>
              <div><strong>Day <span id="mining-day-blueGems">?</span> Colony Needs: <span id="mining-need-blueGems" style="color: #ffff00;">15</span></strong> | Base Value: $12</div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustEffort('blueGems', -1)">➖</button>
              <span class="count-display" id="effortCount-blueGems">0</span>
              <button type="button" onclick="adjustEffort('blueGems', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🌱</span>
              <div><strong>Day <span id="mining-day-greenPoison">?</span> Colony Needs: <span id="mining-need-greenPoison" style="color: #ffff00;">15</span></strong> | Base Value: $10</div>
        </div>
        <div class="sell-controls">
              <button type="button" onclick="adjustEffort('greenPoison', -1)">➖</button>
              <span class="count-display" id="effortCount-greenPoison">0</span>
              <button type="button" onclick="adjustEffort('greenPoison', 1)">➕</button>
        </div>
      </div>
    </div>

        <!-- Raid Decisions (THIRD - NIGHT) -->
        <div class="decision-section">
          <h2>⚔️ Raid Other Tribes</h2>
          <p>Spend 2🌱 to attempt to raid 2 units of a resource from another player. Success is not guaranteed.</p>
      
      <div class="raid-controls">
        <div class="raid-dropdown">
              <label for="raidTarget">Target Player:</label>
          <select id="raidTarget">
            <option value="none">None</option>
          </select>
        </div>
        <div class="raid-dropdown">
              <label for="raidMaterial">Target Resource:</label>
          <select id="raidMaterial">
                <option value="none">None</option>
            <option value="whiteDiamonds">💎 White Diamonds</option>
            <option value="redRubies">🔻 Red Rubies</option>
            <option value="blueGems">🔷 Blue Gems</option>
            <option value="greenPoison">🌱 Green Poison</option>
          </select>
            </div>
        </div>
      </div>
      
        <!-- Blocking Decisions (FOURTH - DEFENSE) -->
        <div class="decision-section" style="background: rgba(0, 255, 0, 0.05); border: 2px solid rgba(0, 255, 0, 0.3);">
          <h2>🛡️ Block Raids</h2>
          <p>Choose ONE player to block from raiding you tonight. You can completely stop one raid attempt.</p>
          
          <div class="raid-controls">
            <div class="raid-dropdown">
              <label>Choose Player to Block:</label>
              <select id="blockTarget">
                <option value="none">None</option>
              </select>
        </div>
      </div>
    </div>

        <!-- Submit Decisions Button (Replace the current submit button area) -->
    <div class="button-group">
          <button class="submit-btn" id="submitBtn" onclick="submitDecisions()">
            🚀 SUBMIT DECISIONS FOR DAY <span id="submitDayNumber">?</span> 🚀
          </button>
    </div>

    <div id="message" class="message"></div>
    
        <!-- 3. Auto-advance notification (add after message div) -->
        <div id="autoAdvanceNotification" class="auto-advance-notification" style="display: none;">
          <div class="notification-content">
            <span class="notification-icon">🤖</span>
            <span class="notification-text">All players submitted! Auto-advancing in <span id="autoAdvanceCountdown">300</span> seconds...</span>
            <button class="notification-btn" onclick="processDay()">⚡ PROCESS NOW</button>
          </div>
        </div>

        <!-- REPLACE YOUR EXISTING NEWS SECTION IN main.html WITH THIS -->
        <section class="decision-section">
          <h2>📰 Daily News Command Center</h2>
          
          <!-- News Controls -->
          <div class="news-controls">
            <button class="news-toggle active" data-view="structured" onclick="toggleNewsView('structured')">
              📋 Organized View
            </button>
            <button class="news-toggle" data-view="simple" onclick="toggleNewsView('simple')">
              📜 Simple Feed
            </button>
            <select id="newsFilter" onchange="filterNews()">
              <option value="all">All Categories</option>
              <option value="raid">⚔️ Raids Only</option>
              <option value="mining">⛏️ Mining Only</option>
              <option value="market">📈 Market Only</option>
              <option value="general">📰 General Only</option>
            </select>
          </div>
          
          <!-- Structured News View -->
          <div id="structuredNewsView" class="news-view">
            <div id="structuredNewsContainer"></div>
          </div>
          
          <!-- Simple News View (fallback) -->
          <div id="simpleNewsView" class="news-view" style="display: none;">
            <ul id="newsBoard"></ul>
          </div>
        </section>

        <div class="decision-section">
            <h2>👑 Leaderboard</h2>
            <table>
                <thead>
                    <tr>
                        <th>Commander</th>
                        <th>Tribe</th>
                        <th>Credits</th>
                        <th>Resources</th>
                        <th>Submitted</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <!-- Leaderboard data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Admin Controls Section (Add this before closing container div) -->
        <div class="admin-section" id="adminSection">
      <div class="admin-buttons">
            <button class="process-btn" onclick="processDay()">⚡ ADMIN: PROCESS NEXT DAY</button>
            <button class="admin-btn reset-btn" onclick="resetGame()">💀 RESET GAME</button>
            <button class="admin-btn debug-btn" onclick="clearSubmissionStatus()">🔧 CLEAR FRONTEND STATUS</button>
            <button class="admin-btn debug-btn" onclick="clearServerDecisions()">🗑️ CLEAR SERVER DECISIONS</button>
            <button class="admin-btn nuclear-btn" onclick="forceClearAllDecisions()">💥 FORCE CLEAR ALL DECISIONS</button>
          </div>
        </div>
    </div>

    <!-- 2. Final Standings Modal (add before closing body tag) -->
    <div id="gameEndModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>🏆 GALACTIC CONQUEST COMPLETE! 🏆</h2>
        </div>
        <div class="modal-body">
          <div class="winner-showcase">
            <div class="winner-title">SUPREME COMMANDER</div>
            <div class="winner-name" id="modalWinnerName">Dave</div>
            <div class="winner-score">$<span id="modalWinnerCredits">1000</span></div>
          </div>
          
          <div class="final-standings">
            <h3>Final Galactic Standings</h3>
            <div id="finalStandingsTable"></div>
          </div>
          
          <div class="game-summary">
            <h3>10-Day Campaign Summary</h3>
            <div id="gameSummary">
              <p>After 10 days of mining, trading, and raiding across the galaxy, 
              the tribes have determined their ultimate leader!</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn new-game-btn" onclick="startNewGame()">🚀 START NEW CONQUEST</button>
          <button class="modal-btn close-btn" onclick="closeGameEndModal()">📊 VIEW FINAL STATE</button>
      </div>
    </div>
  </div>

  <script>
        let playerId = localStorage.getItem('playerId');
        let gameData = null;
        let robotAssignments = {
      whiteDiamonds: 0,
      redRubies: 0,
      blueGems: 0,
      greenPoison: 0
    };
        let sellAssignments = {
      whiteDiamonds: 0,
      redRubies: 0,
      blueGems: 0,
      greenPoison: 0
    };
        let totalRobots = 12; // Ensure this matches the HTML display
        let rollResult = 0;
        let hasRolled = false;

        // Game status variables
        let autoAdvanceCountdown = null;
        let autoAdvanceTimer = null;

        // Dump functionality variables
        let currentDumpAmount = 1;
        let selectedDumpResource = 'none';

        // News display variables
        let currentNewsView = 'structured';
        let currentNewsFilter = 'all';
        let newsCategories = {};

        function getResourceIcon(resource) {
            switch(resource) {
                case 'whiteDiamonds': return '💎';
                case 'redRubies': return '🔻';
                case 'blueGems': return '🔷';
                case 'greenPoison': return '🌱';
                default: return '';
            }
        }

        function showMessage(msg, type = 'info') {
            const messageDiv = document.getElementById('message');
            if (messageDiv) { // Add this null check
                messageDiv.textContent = msg;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            } else {
                console.error("Error: Message div with ID 'message' not found in the DOM. Message was:", msg);
                // Fallback to alert if the message div is truly missing
                alert(`Game Message: ${msg}`);
            }
        }
        
        // Function to clear submission status manually (for debugging)
        function clearSubmissionStatus() {
            const currentDay = gameData?.gameState?.currentDay || 1;
            const submissionKey = `submitted_day_${currentDay}`;
            localStorage.removeItem(submissionKey);
            
            // Also clear any other submission keys
            for (let i = 1; i <= 10; i++) {
                localStorage.removeItem(`submitted_day_${i}`);
            }
            
            showMessage('Frontend submission status cleared! You can now submit decisions again.', 'success');
            updateSubmitButton();
        }
        
        // Function to clear server-side decisions for current day
        function clearServerDecisions() {
            const currentDay = gameData?.gameState?.currentDay || 1;
            
            fetch(`/clear-decisions/${currentDay}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showMessage(`Server decisions for day ${currentDay} cleared! You can now submit new decisions.`, 'success');
                        updateSubmitButton();
                    } else {
                        showMessage(data.error || 'Failed to clear server decisions', 'error');
                    }
                })
                .catch(err => {
                    console.error('Error clearing server decisions:', err);
                    showMessage('Failed to clear server decisions', 'error');
                });
        }
        
        // Function to force clear ALL decisions (nuclear option)
        function forceClearAllDecisions() {
            if (!confirm('This will clear ALL decisions for ALL players for the current day. Continue?')) {
                return;
            }
            
            const currentDay = gameData?.gameState?.currentDay || 1;
            
            fetch(`/force-clear-decisions/${currentDay}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showMessage(`ALL decisions for day ${currentDay} force cleared! You can now submit new decisions.`, 'success');
                        updateSubmitButton();
                    } else {
                        showMessage(data.error || 'Failed to force clear decisions', 'error');
                    }
                })
                .catch(err => {
                    console.error('Error force clearing decisions:', err);
                    showMessage('Failed to force clear decisions', 'error');
                });
        }

    function updateRobotDisplay() {
            const robotsContainer = document.getElementById('robotsContainer');
            if (!robotsContainer) return;
            
            robotsContainer.innerHTML = '';
            
            // Calculate assigned and unassigned robots
            const assignedRobots = Object.values(robotAssignments).reduce((a, b) => a + b, 0);
            const unassignedRobots = totalRobots - assignedRobots; // Now unassignedRobots is properly defined
            
            // Display unassigned robots
            for (let i = 0; i < unassignedRobots; i++) {
                const robot = document.createElement('span');
          robot.className = 'robot available';
                robot.textContent = '🤖';
                robot.id = `robot-${i}`;
                robotsContainer.appendChild(robot);
            }
            
            // Update the available robot count in the player header
            const robotCountSpan = document.getElementById('robotCount');
            if (robotCountSpan) {
                robotCountSpan.textContent = unassignedRobots;
            }
        }

        function adjustEffort(resource, amount) {
            // if (typeof trackUserActivity === 'function') trackUserActivity(); // Assuming this is defined elsewhere
            
            const currentEffort = robotAssignments[resource] || 0;
            const assignedRobots = Object.values(robotAssignments).reduce((a, b) => a + b, 0);

            if (amount > 0) {
                // Adding robots
                if (assignedRobots < totalRobots) {
                    robotAssignments[resource] = currentEffort + amount;
                } else {
                    showMessage('No more robots available!', 'error');
                    return;
                }
            } else {
                // Removing robots
                if (currentEffort > 0) {
                    robotAssignments[resource] = Math.max(0, currentEffort + amount);
                } else {
                    showMessage('Cannot assign negative robots!', 'error');
                    return;
                }
            }
            
            // Update the display
            const effortCountElement = document.getElementById(`effortCount-${resource}`);
            if (effortCountElement) {
                effortCountElement.textContent = robotAssignments[resource];
            }
            
            updateRobotDisplay();
            updateButtonStates(); // Call to update button states
        }

        function adjustSell(resource, amount) {
            const currentSell = sellAssignments[resource];
            const availableStock = gameData.stockpiles[resource] || 0;
            const protectedStock = gameData.protectedResources[resource] || 0;
            const totalAvailable = availableStock + protectedStock;

            if (amount > 0) {
                if (currentSell < totalAvailable && currentSell < 15) { // Max 15 per resource
                    sellAssignments[resource] = currentSell + amount;
                } else {
                    showMessage(`Cannot sell more than 15 units or more than you have of ${resource}!`, 'error');
                }
            } else {
                if (currentSell > 0) {
                    sellAssignments[resource] = currentSell + amount;
                } else {
                    showMessage('Cannot sell negative units!', 'error');
                }
            }
            const sellCountElement = document.getElementById(`sellCount-${resource}`);
            if (sellCountElement) sellCountElement.textContent = sellAssignments[resource];
            updateButtonStates(); // Call to update button states
        }

        function rollDice() {
            rollResult = Math.floor(Math.random() * 6) + 1; // 1-6
            const diceResultElement = document.getElementById('diceResult');
            if (diceResultElement) diceResultElement.textContent = `Roll: ${rollResult}`;
            hasRolled = true;
            if (rollResult < 2) {
                showMessage('💀 Dice roll failed! Raid will not be attempted.', 'error');
            } else {
                showMessage('✅ Dice roll successful! Raid will be attempted.', 'success');
            }
        }

        function submitDecisions() {
            // Check if playerId is available
            if (!playerId) {
                showMessage('❌ Player ID not found. Please refresh the page or log in again.', 'error');
                return;
            }
            
            // Check if game data is loaded
            if (!gameData || !gameData.gameState) {
                showMessage('❌ Game data not loaded. Please wait for the page to fully load.', 'error');
                return;
            }
            
            const totalRobotsAssigned = Object.values(robotAssignments).reduce((a, b) => a + b, 0);
            
            if (totalRobotsAssigned === 0) {
                showMessage('You must assign at least one mining robot!', 'error');
                return;
            }
            if (totalRobotsAssigned > totalRobots) { // Use totalRobots variable
                showMessage(`Too many robots assigned! Maximum is ${totalRobots}.`, 'error');
                return;
            }

            const raidTarget = document.getElementById('raidTarget').value;
            const raidMaterial = document.getElementById('raidMaterial').value || null;
            const blockTarget = document.getElementById('blockTarget').value;

            // Validate raid selection
            if (raidTarget !== 'none' && !raidMaterial) {
                showMessage('⚠️ You must select a raid target but no resource! Please choose which resource to steal.', 'error');
                return;
            }
            
            // Check dice roll for raids
            if (raidTarget !== 'none' && raidMaterial) {
                if (!hasRolled) {
                    showMessage('⚠️ You must roll the dice before submitting a raid!', 'error');
                    return;
                }
                if (rollResult < 2) {
                    showMessage('💀 Your dice roll failed! Raid will not be attempted.', 'error');
                    const raidTargetElement = document.getElementById('raidTarget');
                    if (raidTargetElement) raidTargetElement.value = 'none';
                    const raidMaterialElement = document.getElementById('raidMaterial');
                    if (raidMaterialElement) raidMaterialElement.value = '';
                    updateDiceSection();
                }
            }

            const decisions = {
                playerId: playerId,
                day: gameData ? gameData.gameState.currentDay : 1,
                efforts: robotAssignments,
                sales: sellAssignments,
                raidTarget: rollResult >= 2 ? (raidTarget === 'none' ? null : raidTarget) : null,
                raidMaterial: rollResult >= 2 ? raidMaterial : null,
                blockTarget: blockTarget || 'none'
            };

            fetch('/submit-decisions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(decisions)
            })
            .then(res => res.json())
        .then(data => {
          if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(data.message, 'success');
                    
                    // Mark this day as submitted in localStorage
                    const currentDay = gameData?.gameState?.currentDay || 1;
                    const submissionKey = `submitted_day_${currentDay}`;
                    localStorage.setItem(submissionKey, 'true');
                    
                    // Update the submit button state immediately
                    updateSubmitButton();
                    
                    // Reload data to show updated submission status
                    loadGameDataEnhanced();
                }
        })
        .catch(err => {
                console.error('Submit error:', err);
                showMessage('Failed to submit decisions', 'error');
            });
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset the entire game? All player data will be wiped!')) {
                fetch('/reset-game', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            localStorage.removeItem('playerId');
                            window.location.href = '/'; // Redirect to login
                        } else {
                            showMessage(data.error, 'error');
                        }
                    })
                    .catch(err => {
                        console.error('Reset error:', err);
                        showMessage('Failed to reset game', 'error');
                    });
            }
        }

        function updateDiceSection() {
            const diceResultElement = document.getElementById('diceResult');
            if (diceResultElement) diceResultElement.textContent = `Roll: ${rollResult}`;
            // You might want to disable the roll button after rolling
            // const rollDiceButtonElement = document.getElementById('rollDiceButton');
            // if (rollDiceButtonElement) rollDiceButtonElement.disabled = hasRolled;
        }

        // New function to update player-specific header info
        function updatePlayerStatus() {
            if (!gameData || !gameData.player) return;
            
            const currentDayElement = document.getElementById('currentDay');
            if (currentDayElement) currentDayElement.textContent = gameData.gameState?.currentDay || '?';

            const playerCreditsElement = document.getElementById('playerCredits');
            if (playerCreditsElement) playerCreditsElement.textContent = gameData.player?.credits || 0;

            const playerRaceElement = document.getElementById('playerRace');
            if (playerRaceElement) playerRaceElement.textContent = gameData.player?.race || 'Unknown';

            const playerCommanderElement = document.getElementById('playerCommander');
            if (playerCommanderElement) playerCommanderElement.textContent = gameData.player?.name || 'Unknown';

            const tribeNameElement = document.getElementById('tribeName');
            if (tribeNameElement) tribeNameElement.textContent = gameData.player?.race || 'Unknown';

            // Update player icon based on race/name if needed
            const playerIconElement = document.getElementById('playerIcon');
            if (playerIconElement) {
                // Example: Set icon based on race or name
                switch (gameData.player?.name) {
                    case 'Dave': playerIconElement.textContent = '🐻'; break;
                    case 'Silas': playerIconElement.textContent = '🦊'; break;
                    case 'Chris': playerIconElement.textContent = '🐺'; break;
                    case 'Brian': playerIconElement.textContent = '🦁'; break;
                    case 'Joel': playerIconElement.textContent = '🐯'; break;
                    case 'Curtis': playerIconElement.textContent = '🐼'; break;
                    default: playerIconElement.textContent = '👽'; // Default icon
                }
            }
        }

        // New function to update the submit button state
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            const submitDaySpan = document.getElementById('submitDayNumber');
            
            if (!submitBtn || !gameData) return;
            
            const currentDay = gameData.gameState?.currentDay || '?';
            if (submitDaySpan) submitDaySpan.textContent = currentDay;
            
            // Check if player has already submitted decisions for this day
            // We'll check localStorage to track submission status
            const submissionKey = `submitted_day_${currentDay}`;
            const hasSubmitted = localStorage.getItem(submissionKey) === 'true';
            
            if (hasSubmitted) {
                submitBtn.innerHTML = `✅ DECISIONS SUBMITTED FOR DAY ${currentDay} ✅`;
                submitBtn.style.background = 'linear-gradient(135deg, #666, #888)';
                submitBtn.style.color = '#ccc';
                submitBtn.disabled = true;
            } else {
                submitBtn.innerHTML = `🚀 SUBMIT DECISIONS FOR DAY ${currentDay} 🚀`;
                submitBtn.style.background = 'linear-gradient(135deg, #00ff00, #00cc00)';
                submitBtn.style.color = '#000';
                submitBtn.disabled = false;
            }
        }

        // New function to update the admin section visibility (e.g., for specific players)
        function updateAdminSection() {
            const adminSection = document.getElementById('adminSection'); // Changed to getElementById
            if (adminSection) {
                // Show admin section for all players during development/testing
                // TODO: Restrict to specific players in production
                adminSection.style.display = 'block';
            }
        }

        // Helper function to update the state of +/- buttons for efforts and sales
        function updateButtonStates() {
            const totalAssigned = Object.values(robotAssignments).reduce((a, b) => a + b, 0);
            
            // Update effort buttons
          Object.keys(robotAssignments).forEach(resource => {
                const effortMinus = document.querySelector(`[onclick="adjustEffort('${resource}', -1)"]`);
                const effortPlus = document.querySelector(`[onclick="adjustEffort('${resource}', 1)"]`);
                
                if (effortMinus) effortMinus.disabled = robotAssignments[resource] === 0;
                if (effortPlus) effortPlus.disabled = totalAssigned >= totalRobots;
            });
            
            // Update selling buttons
            if (gameData && gameData.player?.stockpiles) {
                Object.keys(sellAssignments).forEach(resource => {
                    const sellMinus = document.querySelector(`[onclick="adjustSell('${resource}', -1)"]`);
                    const sellPlus = document.querySelector(`[onclick="adjustSell('${resource}', 1)"]`);
                    
                    if (sellMinus) sellMinus.disabled = sellAssignments[resource] === 0;
                    if (sellPlus) {
          const available = gameData.player.stockpiles[resource] || 0;
                        const protectedRes = gameData.player.protectedResources?.[resource] || 0;
                        const maxSell = Math.min(available + protectedRes, 15); // Max 15 or what's available
                        sellPlus.disabled = sellAssignments[resource] >= maxSell;
                    }
                });
            }
        }

        function updateUI(gameData) {
            // Update player status (new centralized function)
            updatePlayerStatus();
            
            // Update day numbers and colony needs
            const sellDayNumberElement = document.getElementById('sellDayNumber');
            if (sellDayNumberElement) sellDayNumberElement.textContent = gameData.gameState?.currentDay || '?';
            const miningDayNumberElement = document.getElementById('miningDayNumber');
            if (miningDayNumberElement) miningDayNumberElement.textContent = (gameData.gameState?.currentDay || 0) + 1;

            // Update selling section with current day colony needs
            if (gameData.gameState?.colonyNeeds) {
              const resources = ['whiteDiamonds', 'redRubies', 'blueGems', 'greenPoison'];
              resources.forEach(resource => {
                const sellDayElement = document.getElementById(`sell-day-${resource}`);
                if (sellDayElement) sellDayElement.textContent = gameData.gameState.currentDay || '?';
                const sellNeedElement = document.getElementById(`sell-need-${resource}`);
                if (sellNeedElement) sellNeedElement.textContent = gameData.gameState.colonyNeeds[resource] || 15;
              });
            }

            // Update mining section with tomorrow's colony needs
            if (gameData.gameState?.tomorrowColonyNeeds) {
              const resources = ['whiteDiamonds', 'redRubies', 'blueGems', 'greenPoison'];
              resources.forEach(resource => {
                const miningDayElement = document.getElementById(`mining-day-${resource}`);
                if (miningDayElement) miningDayElement.textContent = (gameData.gameState.currentDay || 0) + 1;
                const miningNeedElement = document.getElementById(`mining-need-${resource}`);
                if (miningNeedElement) miningNeedElement.textContent = gameData.gameState.tomorrowColonyNeeds[resource] || 15;
              });
            }

                        // Update stockpiles display for selling decisions
            if (gameData.player?.stockpiles) {
              const resources = ['whiteDiamonds', 'redRubies', 'blueGems', 'greenPoison'];
              resources.forEach(resource => {
                const stockpileAmount = gameData.player.stockpiles[resource] || 0;
                
                const stockpilesElement = document.getElementById(`stockpiles-${resource}`);
                if (stockpilesElement) stockpilesElement.textContent = stockpileAmount;
                
                const totalAvailableElement = document.getElementById(`total-available-${resource}`);
                if (totalAvailableElement) totalAvailableElement.textContent = stockpileAmount;
              });
            }

            // Update market prices
            if (gameData.gameState?.prices) {
              const priceWhiteDiamonds = document.getElementById('price-whiteDiamonds');
              if (priceWhiteDiamonds) priceWhiteDiamonds.textContent = gameData.gameState.prices.whiteDiamonds || 20;
              const priceRedRubies = document.getElementById('price-redRubies');
              if (priceRedRubies) priceRedRubies.textContent = gameData.gameState.prices.redRubies || 15;
              const priceBlueGems = document.getElementById('price-blueGems');
              if (priceBlueGems) priceBlueGems.textContent = gameData.gameState.prices.blueGems || 12;
              const priceGreenPoison = document.getElementById('price-greenPoison');
              if (priceGreenPoison) priceGreenPoison.textContent = gameData.gameState.prices.greenPoison || 10;
            }


            // Update last night's sales
            const lastNightSalesDiv = document.getElementById('lastNightSales');
            if (lastNightSalesDiv) { // Add null check
                lastNightSalesDiv.innerHTML = '';
                if (gameData.lastNightSales && Array.isArray(gameData.lastNightSales) && gameData.lastNightSales.length > 0) {
                  gameData.lastNightSales.forEach(sale => {
                    lastNightSalesDiv.innerHTML += `<p>${sale.quantity} ${getResourceIcon(sale.resource)} sold for $${sale.pricePerUnit} each. Total: $${sale.totalEarned}</p>`;
                  });
                  lastNightSalesDiv.innerHTML += `<p><strong>Total Earnings: $${gameData.totalEarned || 0}</strong></p>`;
        } else {
                  lastNightSalesDiv.innerHTML = '<p>No sales last night.</p>';
                }
            }


            // Update news feed (old simple feed) - this will be replaced by updateNewsDisplay
            // const newsFeed = document.getElementById('newsFeed');
            // newsFeed.innerHTML = '';
            // if (gameData.news && gameData.news.length > 0) {
            //   gameData.news.forEach(message => {
            //     const p = document.createElement('p');
            //     p.textContent = message;
            //     newsFeed.appendChild(p);
            //   });
            // } else {
            //   newsFeed.innerHTML = '<p>No new transmissions.</p>';
            // }

            // Update leaderboard
            const leaderboardBody = document.getElementById('leaderboardBody');
            if (leaderboardBody && gameData.leaderboard && Array.isArray(gameData.leaderboard)) { // Add null check
                leaderboardBody.innerHTML = '';
        gameData.leaderboard.forEach(player => {
          const row = document.createElement('tr');
                  const playerStockpiles = player.stockpiles;
                  const totalPlayerResources = Object.values(playerStockpiles).reduce((sum, val) => sum + val, 0);
          row.innerHTML = `
            <td>${player.name}</td>
                    <td>${player.race}</td>
                    <td>${player.credits}</td>
                    <td>${totalPlayerResources}</td>
                    <td>${player.hasSubmitted ? '✅' : '❌'}</td>
                  `;
                  leaderboardBody.appendChild(row);
                });
            }


            // Populate raid target dropdown
            const raidTargetSelect = document.getElementById('raidTarget');
            if (raidTargetSelect && gameData.leaderboard && Array.isArray(gameData.leaderboard)) { // Add null check
                raidTargetSelect.innerHTML = '<option value="none">None</option>';
                gameData.leaderboard.forEach(player => {

                  if (player.id !== gameData.playerId) { // Cannot raid self
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    raidTargetSelect.appendChild(option);
                  }
                });
                // Set selected raid target if it exists in gameData
                if (gameData.raidTarget && gameData.raidTarget !== 'none') {
                  raidTargetSelect.value = gameData.raidTarget;
                } else {
                  raidTargetSelect.value = 'none';
                }
            }


            // Populate block targets (same as raid targets)
            const blockTarget = document.getElementById('blockTarget');
            if (blockTarget && gameData.leaderboard && Array.isArray(gameData.leaderboard)) {
              blockTarget.innerHTML = '<option value="none">None</option>';
        gameData.leaderboard.forEach(player => {
          if (player.name !== gameData.playerName) {
            const option = document.createElement('option');
            option.value = player.name;
            option.textContent = player.name;
                  if (gameData.blockTarget === player.name) {
              option.selected = true;
            }
                  blockTarget.appendChild(option);
                }
              });
            }

            // Set current efforts
            if (gameData.efforts) {
              for (const resource in gameData.efforts) {
                const effortCountElement = document.getElementById(`effortCount-${resource}`);
                if (effortCountElement) effortCountElement.textContent = gameData.efforts[resource];
              }
            }

            // Set current sales
            if (gameData.sales) {
              for (const resource in gameData.sales) {
                const sellCountElement = document.getElementById(`sellCount-${resource}`);
                if (sellCountElement) sellCountElement.textContent = gameData.sales[resource];
              }
            }

            // Update submit button state (now handled by updateSubmitButton)
            // const submitButton = document.getElementById('submitDecisions');
            // if (submitButton) { // Add null check
            //     if (gameData.hasSubmitted) {
            //       submitButton.textContent = 'Decisions Submitted (Update)';
            //       submitButton.classList.add('submitted');
            //     } else {
            //       submitButton.textContent = 'Submit Decisions';
            //       submitButton.classList.remove('submitted');
            //     }
            // }


            updateRobotDisplay(); // Ensure robot display is updated after UI refresh
            updateDumpDisplay(); // Update dump section display
            updateNewsDisplay(); // NEW: Update news display with structured news
            updateSubmitButton(); // NEW: Update the submit button state
            updateAdminSection(); // NEW: Update the admin section visibility
            updateButtonStates(); // NEW: Update the state of +/- buttons
            updatePlayerStatusDashboard(); // NEW: Update the player status dashboard
        }

        // Update player status dashboard
        function updatePlayerStatusDashboard() {
          // Update dashboard day
          const dashboardDayElement = document.getElementById('dashboardDay');
          if (dashboardDayElement && gameData?.gameState?.currentDay) {
            dashboardDayElement.textContent = gameData.gameState.currentDay;
          }

          // Load player status from server
          loadPlayerStatus();
        }

        // Load and display player status
        function loadPlayerStatus() {
          fetch('/players-status')
            .then(res => res.json())
            .then(data => {
              if (data.error) {
                console.error('Failed to load player status:', data.error);
                return;
              }
              
              displayPlayerStatus(data);
            })
            .catch(err => {
              console.error('Error loading player status:', err);
            });
        }

        // Display player status in the dashboard
        function displayPlayerStatus(data) {
          const dashboard = document.getElementById('playersDashboard');
          if (!dashboard) return;

          dashboard.innerHTML = '';

          data.players.forEach(player => {
            const card = document.createElement('div');
            card.className = `player-status-card ${player.hasSubmitted ? 'active' : 'waiting'}`;
            
            const statusClass = player.hasSubmitted ? 'active' : 'waiting';
            const statusText = player.hasSubmitted ? '✅ Active' : '🟡 Waiting';
            
            card.innerHTML = `
              <div class="player-header-info">
                <div>
                  <div class="player-name">${player.name}</div>
                  <div class="player-race">${player.race}</div>
                </div>
                <div class="player-status ${statusClass}">${statusText}</div>
              </div>
              
              <div class="player-details">
                <div class="player-stats">
                  <div class="stat-item">
                    <span class="stat-label">Credits:</span>
                    <span class="stat-value">$${player.credits}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Resources:</span>
                    <span class="stat-value">${Object.values(player.stockpiles).reduce((sum, val) => sum + val, 0)}</span>
                  </div>
                </div>
                
                <div class="player-activity">
                  ${player.details}
                </div>
              </div>
            `;

            // Add click event to show more details
            card.addEventListener('click', () => {
              showPlayerDetails(player);
            });

            dashboard.appendChild(card);
          });

          // Update submission count in game status
          const submittedCountElement = document.getElementById('submittedCount');
          if (submittedCountElement) {
            submittedCountElement.textContent = data.submittedCount;
          }
          
          const activePlayerCountElement = document.getElementById('activePlayerCount');
          if (activePlayerCountElement) {
            activePlayerCountElement.textContent = data.totalPlayers;
          }
        }

        // Show detailed player information
        function showPlayerDetails(player) {
          const details = `
            🎯 ${player.name} (${player.race})
            
            💰 Credits: $${player.credits}
            
            📦 Stockpiles:
            💎 White Diamonds: ${player.stockpiles.whiteDiamonds || 0}
            🔻 Red Rubies: ${player.stockpiles.redRubies || 0}
            🔷 Blue Gems: ${player.stockpiles.blueGems || 0}
            🌱 Green Poison: ${player.stockpiles.greenPoison || 0}
            
            📊 Status: ${player.status}
            📝 Details: ${player.details}
          `;
          
          alert(details);
        }

        // Update game status display
        function updateGameStatus() {
          if (!gameData || !gameData.gameStatus) return;
          
          const status = gameData.gameStatus;
          const statusCurrentDayElement = document.getElementById('statusCurrentDay');
          const daysRemainingElement = document.getElementById('daysRemaining');
          const submittedCountElement = document.getElementById('submittedCount');
          const activePlayerCountElement = document.getElementById('activePlayerCount');
          const autoStatus = document.getElementById('autoAdvanceStatus');
          const activeGameStatusElement = document.getElementById('activeGameStatus');
          const gameEndedStatusElement = document.getElementById('gameEndedStatus');

          if (status.isGameEnded) {
            // Show game ended status
            if (activeGameStatusElement) activeGameStatusElement.style.display = 'none';
            if (gameEndedStatusElement) gameEndedStatusElement.style.display = 'block';
            
            if (gameData.winner) {
              const winnerNameElement = document.getElementById('winnerName');
              if (winnerNameElement) winnerNameElement.textContent = gameData.winner.name;
              const winnerCreditsElement = document.getElementById('winnerCredits');
              if (winnerCreditsElement) winnerCreditsElement.textContent = gameData.winner.credits;
            }
          } else {
            // Show active game status
            if (activeGameStatusElement) activeGameStatusElement.style.display = 'block';
            if (gameEndedStatusElement) gameEndedStatusElement.style.display = 'none';
            
            if (statusCurrentDayElement) statusCurrentDayElement.textContent = status.currentDay;
            if (daysRemainingElement) daysRemainingElement.textContent = status.daysRemaining;
            
            // Corrected access to submission status counts
            if (submittedCountElement) submittedCountElement.textContent = status.submissionStatus.submittedCount;
            if (activePlayerCountElement) activePlayerCountElement.textContent = status.submissionStatus.activeCount;
            
            // Update auto-advance status
            if (autoStatus) { // Add null check
                if (status.canAutoAdvance) {
                  autoStatus.textContent = '🤖 Ready to auto-advance!';
                  autoStatus.style.color = '#00ff00';
                  showAutoAdvanceNotification();
        } else {
                  autoStatus.textContent = '⏳ Waiting for submissions...';
                  autoStatus.style.color = '#ffff00';
                  hideAutoAdvanceNotification();
                }
            }
          }
        }

        // Show auto-advance notification with countdown
        function showAutoAdvanceNotification() {
          const notification = document.getElementById('autoAdvanceNotification');
          if (notification) { // Add null check
            notification.style.display = 'block';
            
            let countdown = 300; // 5 minutes
            const autoAdvanceCountdownElement = document.getElementById('autoAdvanceCountdown');
            if (autoAdvanceCountdownElement) autoAdvanceCountdownElement.textContent = countdown;
            
            if (autoAdvanceTimer) clearInterval(autoAdvanceTimer);
            
            autoAdvanceTimer = setInterval(() => {
              countdown--;
              if (autoAdvanceCountdownElement) autoAdvanceCountdownElement.textContent = countdown;
              
              if (countdown <= 0) {
                clearInterval(autoAdvanceTimer);
                autoProcessDay();
              }
            }, 1000);
          }
        }

        // Hide auto-advance notification
        function hideAutoAdvanceNotification() {
          const notification = document.getElementById('autoAdvanceNotification');
          if (notification) { // Add null check
            notification.style.display = 'none';
            if (autoAdvanceTimer) {
              clearInterval(autoAdvanceTimer);
              autoAdvanceTimer = null;
            }
          }
        }

        // Auto-process day when countdown reaches zero
        function autoProcessDay() {
          showMessage('🤖 Auto-advancing day...', 'success');
          processDay();
        }

        // Show game end modal
        function showGameEndModal(gameResult) {
          const modal = document.getElementById('gameEndModal');
          if (modal) { // Add null check
            // Update winner info
            const modalWinnerNameElement = document.getElementById('modalWinnerName');
            if (modalWinnerNameElement) modalWinnerNameElement.textContent = gameResult.winner.name;
            const modalWinnerCreditsElement = document.getElementById('modalWinnerCredits');
            if (modalWinnerCreditsElement) modalWinnerCreditsElement.textContent = gameResult.winner.credits;
            
            // Update final standings
            const standingsTable = document.getElementById('finalStandingsTable');
            if (standingsTable) { // Add null check
                standingsTable.innerHTML = '';
                
                gameResult.finalStandings.forEach((player, index) => {
                  const row = document.createElement('div');
                  row.className = 'standings-row';
                  
                  if (index === 0) row.classList.add('first');
                  else if (index === 1) row.classList.add('second');
                  else if (index === 2) row.classList.add('third');
                  
                  const medals = ['🥇', '🥈', '🥉'];
                  const medal = index < 3 ? medals[index] : `${index + 1}.`;
                  
                  row.innerHTML = `
                    <span>${medal} ${player.name}</span>
                    <span>$${player.credits}</span>
                  `;
                  standingsTable.appendChild(row);
                });
            }
            
            modal.style.display = 'flex';
          }
        }

        // Close game end modal
        function closeGameEndModal() {
          const modal = document.getElementById('gameEndModal');
          if (modal) modal.style.display = 'none'; // Add null check
        }

        // Start new game
        function startNewGame() {
          if (confirm('🚀 Start a new 10-day galactic conquest? This will reset all progress!')) {
            resetGame();
            closeGameEndModal();
          }
        }

        // Enhanced loadGameData to handle game status
        function loadGameDataEnhanced() {
          fetch(`/game-data/${playerId}`)
            .then(res => {
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
              }
              return res.json();
            })
      .then(data => {
        if (data.error) {
                if (data.error === 'Player not found') {
                  window.location.href = '/';
                  return;
                }
                throw new Error(data.error);
              }
              
              // Debug: Log the actual data structure
              console.log('Game data received:', data);
              
              gameData = data;
              
              // Wrap updateUI in try-catch to prevent crashes
              try {
                updateUI(gameData); // Pass gameData to updateUI
                updateGameStatus(); // Add this line
              } catch (error) {
                console.error('Error in updateUI:', error);
                showMessage(`UI update error: ${error.message}. Some features may not display correctly.`, 'warning');
              }
              
              // Check for game end
              if (data.gameStatus && data.gameStatus.isGameEnded && data.gameStatus.winner) { // Use gameStatus.isGameEnded
                setTimeout(() => showGameEndModal(data.gameStatus), 1000); // Pass gameStatus which contains winner/finalStandings
        }
      })
      .catch(err => {
              if (err.message === 'Player not found') {
                window.location.href = '/';
                return;
              }
              showMessage(`Failed to load game data: ${err.message}`, 'error');
            });
        }

        // Enhanced processDay function
    function processDay() {
          hideAutoAdvanceNotification(); // Hide notification when manually processing
          
      showMessage('Processing day... This may take a moment.', 'success');
      
      fetch('/process-day', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
            } else {
              if (data.gameEnded) {
                showMessage('🏆 Game Complete! Check the final standings!', 'success');
                // Show game end modal after a delay
                setTimeout(() => {
                  showGameEndModal({
                    winner: data.winner,
                    finalStandings: data.finalStandings
                  });
                }, 2000);
        } else {
          showMessage(data.message || 'Day processed successfully!', 'success');
              }
              
          // Reset assignments for new day
          Object.keys(robotAssignments).forEach(resource => {
            robotAssignments[resource] = 0;
            sellAssignments[resource] = 0;
                const effortCountElement = document.getElementById(`effortCount-${resource}`);
                if (effortCountElement) effortCountElement.textContent = '0';
                const sellCountElement = document.getElementById(`sellCount-${resource}`);
                if (sellCountElement) sellCountElement.textContent = '0';
          });
          // Clear raid selections
              const raidTargetElement = document.getElementById('raidTarget');
              if (raidTargetElement) raidTargetElement.value = 'none';
              const raidMaterialElement = document.getElementById('raidMaterial');
              if (raidMaterialElement) raidMaterialElement.value = '';
              const blockTargetElement = document.getElementById('blockTarget'); // Added null check for blockTarget
              if (blockTargetElement) blockTargetElement.value = 'none'; // Reset block target
              updateDiceSection(); // Reset dice display
              
              // Clear submission status for the processed day
              const processedDay = gameData?.gameState?.currentDay || 1;
              const submissionKey = `submitted_day_${processedDay}`;
              localStorage.removeItem(submissionKey);
              
              // Update the submit button state for the new day
              updateSubmitButton();
              
              loadGameDataEnhanced(); // Use enhanced version
        }
      })
      .catch(err => {
        console.error('Process day error:', err);
        showMessage('Failed to process day', 'error');
      });
    }

        // Dump functionality functions
        // Update dump display based on game data
        function updateDumpDisplay() {
          if (!gameData || !gameData.dumpStatus) return;
          
          const dumpAvailable = document.getElementById('dumpAvailable');
          const dumpUsed = document.getElementById('dumpUsed');
          
          if (dumpAvailable && dumpUsed) { // Add null check for containers
            if (gameData.dumpStatus.hasUsedDump) {
              // Show used state
              dumpAvailable.style.display = 'none';
              dumpUsed.style.display = 'block';
              
              const resourceIcons = {
                'whiteDiamonds': '💎',
                'redRubies': '🔻',
                'blueGems': '🔷',
                'greenPoison': '🌱'
              };
              
              const dumpUsedResourceElement = document.getElementById('dumpUsedResource');
              if (dumpUsedResourceElement) dumpUsedResourceElement.textContent = 
                resourceIcons[gameData.dumpStatus.dumpUsedFor] + ' ' + gameData.dumpStatus.dumpUsedFor;
              
              // Find earnings from last night sales (dump transactions)
              const dumpSales = gameData.lastNightSales ? 
                gameData.lastNightSales.filter(sale => sale.is_dump) : [];
              const dumpEarnings = dumpSales.reduce((total, sale) => total + (sale.total_earned || 0), 0);
              const dumpUsedEarningsElement = document.getElementById('dumpUsedEarnings');
              if (dumpUsedEarningsElement) dumpUsedEarningsElement.textContent = dumpEarnings;
            } else {
              // Show available state
              dumpAvailable.style.display = 'block';
              dumpUsed.style.display = 'none';
              
              updateDumpOptions();
            }
          }
        }

        // Update available dump options
        function updateDumpOptions() {
          if (!gameData || !gameData.stockpiles) return;
          
          const dumpResourceSelect = document.getElementById('dumpResource');
          const stockpiles = gameData.stockpiles;
          
          if (dumpResourceSelect) { // Add null check
            // Enable/disable options based on availability
            Array.from(dumpResourceSelect.options).forEach(option => {
              if (option.value === 'none') return;
              
              const available = stockpiles[option.value] || 0;
              option.disabled = available === 0;
              option.textContent = option.textContent.split(' (')[0]; // Remove old availability text
              
              if (available > 0) {
                option.textContent += ` (${available} available)`;
          } else {
                option.textContent += ' (none available)';
              }
            });
          }
        }

        // Handle dump resource selection
        function onDumpResourceChange() {
          const select = document.getElementById('dumpResource');
          if (select) selectedDumpResource = select.value;
          
          const amountSection = document.getElementById('dumpAmountSection');
          const dumpBtn = document.getElementById('dumpBtn');
          
          if (amountSection && dumpBtn) { // Add null check
            if (selectedDumpResource === 'none') {
              amountSection.style.display = 'none';
              dumpBtn.disabled = true;
            } else {
              amountSection.style.display = 'block';
              currentDumpAmount = 1;
              updateDumpAmount();
              updateDumpPreview();
              dumpBtn.disabled = false;
            }
          }
        }

        // Adjust dump amount
        function adjustDump(change) {
          if (!selectedDumpResource || selectedDumpResource === 'none') return;
          
          const available = gameData.stockpiles[selectedDumpResource] || 0;
          const maxDump = Math.min(available, 15);
          
          currentDumpAmount = Math.max(1, Math.min(currentDumpAmount + change, maxDump));
          updateDumpAmount();
          updateDumpPreview();
        }

        // Update dump amount display
        function updateDumpAmount() {
          const dumpAmountElement = document.getElementById('dumpAmount');
          if (dumpAmountElement) dumpAmountElement.textContent = currentDumpAmount;
          
          // Update button states
          const available = gameData.stockpiles[selectedDumpResource] || 0;
          const maxDump = Math.min(available, 15);
          
          const minusBtn = document.querySelector('.dump-amount-controls button:first-child');
          const plusBtn = document.querySelector('.dump-amount-controls button:last-child');
          
          if (minusBtn) minusBtn.disabled = currentDumpAmount <= 1;
          if (plusBtn) plusBtn.disabled = currentDumpAmount >= maxDump;
        }

        // Update dump earnings preview
        function updateDumpPreview() {
          const earnings = currentDumpAmount * 10;
          const dumpEarningsElement = document.getElementById('dumpEarnings');
          if (dumpEarningsElement) dumpEarningsElement.textContent = earnings;
        }

        // Submit dump decision
        function submitDump() {
          if (!selectedDumpResource || selectedDumpResource === 'none' || currentDumpAmount <= 0) {
            showMessage('Please select a resource and amount to dump', 'error');
            return;
          }
          
          // if (typeof trackUserActivity === 'function') trackUserActivity(); // Assuming this is defined elsewhere
          
          const available = gameData.stockpiles[selectedDumpResource] || 0;
          if (currentDumpAmount > available) {
            showMessage(`Only have ${available} ${getResourceIcon(selectedDumpResource)} available`, 'error');
            return;
          }
          
          fetch('/submit-dump', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              playerId,
              dumpResource: selectedDumpResource,
              dumpAmount: currentDumpAmount
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              showMessage(data.error, 'error');
            } else {
              showMessage(data.message || 'Emergency dump successful!', 'success');
              // Reset dump UI
              selectedDumpResource = 'none';
              currentDumpAmount = 1;
              const dumpResourceSelectElement = document.getElementById('dumpResource');
              if (dumpResourceSelectElement) dumpResourceSelectElement.value = 'none';
              const dumpAmountSectionElement = document.getElementById('dumpAmountSection');
              if (dumpAmountSectionElement) dumpAmountSectionElement.style.display = 'none';
              const dumpBtnElement = document.getElementById('dumpBtn');
              if (dumpBtnElement) dumpBtnElement.disabled = true; // Disable button after dump
              // Refresh game data
              loadGameDataEnhanced(); // Use enhanced version
            }
          })
          .catch(err => {
            showMessage('Failed to process dump', 'error');
          });
        }

        // News display functions
        // Load news categories
        function loadNewsCategories() {
          fetch('/news-categories')
            .then(res => res.json())
            .then(categories => {
              newsCategories = categories;
            })
            .catch(err => {
              console.error('Failed to load news categories:', err);
              // Fallback categories
              newsCategories = {
                raid: { icon: '⚔️', color: '#ff6666', title: 'Raid Operations' },
                mining: { icon: '⛏️', color: '#66ff66', title: 'Mining Reports' },
                market: { icon: '📈', color: '#ffaa00', title: 'Market Updates' },
                general: { icon: '📰', color: '#66ccff', title: 'General News' }
              };
            });
        }

        // Toggle between structured and simple news view
        function toggleNewsView(view) {
          currentNewsView = view;
          
          // Update button states
          document.querySelectorAll('.news-toggle').forEach(btn => {
            btn.classList.remove('active');
          });
          const activeToggleBtn = document.querySelector(`[data-view="${view}"]`);
          if (activeToggleBtn) activeToggleBtn.classList.add('active');
          
          // Show/hide views
          const structuredNewsViewElement = document.getElementById('structuredNewsView');
          const simpleNewsViewElement = document.getElementById('simpleNewsView');
          if (structuredNewsViewElement && simpleNewsViewElement) { // Add null check
            if (view === 'structured') {
              structuredNewsViewElement.style.display = 'block';
              simpleNewsViewElement.style.display = 'none';
              renderStructuredNews();
        } else {
              structuredNewsViewElement.style.display = 'none';
              simpleNewsViewElement.style.display = 'block';
              renderSimpleNews();
            }
          }
        }

        // Filter news by category
        function filterNews() {
          const newsFilterElement = document.getElementById('newsFilter');
          if (newsFilterElement) currentNewsFilter = newsFilterElement.value;
          
          if (currentNewsView === 'structured') {
            renderStructuredNews();
      } else {
            renderSimpleNews();
          }
        }

        // Render structured news
        function renderStructuredNews() {
          const container = document.getElementById('structuredNewsContainer');
          if (!gameData || !gameData.structuredNews || !container) { // Add null check for container
            if (container) container.innerHTML = '<div class="no-news">No structured news available</div>';
            return;
          }
          
          container.innerHTML = '';
          
          gameData.structuredNews.forEach(dayData => {
            const daySection = createDaySection(dayData);
            container.appendChild(daySection);
          });
        }

        // Create a day section for structured news
        function createDaySection(dayData) {
          const section = document.createElement('div');
          section.className = 'news-day-section';
          
          // Calculate stats for this day
          const totalItems = ['raid', 'mining', 'market', 'general']
            .reduce((sum, cat) => sum + (dayData[cat] ? dayData[cat].length : 0), 0);
          
          const categoryStats = ['raid', 'mining', 'market', 'general']
            .map(cat => newsCategories[cat] && dayData[cat] && dayData[cat].length > 0 ? `${newsCategories[cat]?.icon || ''}${dayData[cat].length}` : '')
            .filter(stat => stat)
            .join(' ');
          
          // Create header
          const header = document.createElement('div');
          header.className = 'news-day-header';
          header.innerHTML = `
            <div class="day-title">📅 Day ${dayData.day}</div>
            <div class="day-stats">
              <span>${totalItems} updates</span>
              <span>${categoryStats}</span>
            </div>
            <div class="collapse-icon">🔽</div>
          `;
          
          // Create content
          const content = document.createElement('div');
          content.className = 'news-day-content';
          
          // Add summary if day has multiple categories
          if (totalItems > 5) {
            const summary = document.createElement('div');
            summary.className = 'news-summary';
            summary.innerHTML = `
              <div class="summary-stats">
                ${['raid', 'mining', 'market', 'general'].map(cat => {
                  const count = dayData[cat] ? dayData[cat].length : 0;
                  return count > 0 ? `<span class="stat-item">${newsCategories[cat]?.icon || ''}${count}</span>` : '';
                }).filter(item => item).join('')}
              </div>
            `;
            content.appendChild(summary);
          }
          
          // Add categories
          ['raid', 'mining', 'market', 'general'].forEach(category => {
            if (dayData[category] && dayData[category].length > 0) {
              if (currentNewsFilter === 'all' || currentNewsFilter === category) {
                const categorySection = createCategorySection(category, dayData[category]);
                content.appendChild(categorySection);
              }
            }
          });
          
          // Add click handler for collapse/expand
          header.addEventListener('click', () => {
            const isCollapsed = content.style.display === 'none';
            content.style.display = isCollapsed ? 'block' : 'none';
            const icon = header.querySelector('.collapse-icon');
            if (icon) icon.textContent = isCollapsed ? '🔽' : '🔼'; // Add null check
            header.classList.toggle('collapsed', !isCollapsed);
          });
          
          section.appendChild(header);
          section.appendChild(content);
          
          return section;
        }

        // Create a category section
        function createCategorySection(category, items) {
          const section = document.createElement('div');
          section.className = `news-category category-${category}`;
          
          const header = document.createElement('div');
          header.className = 'news-category-header';
          header.innerHTML = `
            <span class="category-icon">${newsCategories[category]?.icon || '📰'}</span>
            <span>${newsCategories[category]?.title || category}</span>
          `;
          
          const itemsList = document.createElement('ul');
          itemsList.className = 'news-items';
          
          items.forEach(item => {
            const listItem = document.createElement('li');
            listItem.className = `news-item ${category} priority-${item.priority || 1}`;
            listItem.textContent = item.message;
            itemsList.appendChild(listItem);
          });
          
          section.appendChild(header);
          section.appendChild(itemsList);
          
          return section;
        }

        // Render simple news (fallback)
        function renderSimpleNews() {
          const newsBoard = document.getElementById('newsBoard');
          if (newsBoard) { // Add null check
            newsBoard.innerHTML = '';
            
            if (gameData && gameData.news && gameData.news.length > 0) {
              gameData.news.slice(-15).forEach(newsItem => {
                const li = document.createElement('li');
                li.textContent = newsItem;
                newsBoard.appendChild(li);
              });
            } else {
              const li = document.createElement('li');
              li.textContent = 'No news yet...';
              li.style.fontStyle = 'italic';
              newsBoard.appendChild(li);
            }
          }
        }

        // Update news display (call this in your existing updateUI function)
        function updateNewsDisplay() {
          if (currentNewsView === 'structured') {
            renderStructuredNews();
          } else {
            renderSimpleNews();
          }
        }

        // Add event listener for dump resource selection
        document.addEventListener('DOMContentLoaded', function() {
          const dumpResourceSelect = document.getElementById('dumpResource');
          if (dumpResourceSelect) {
            dumpResourceSelect.addEventListener('change', onDumpResourceChange);
          }
          loadNewsCategories(); // Load news categories on DOMContentLoaded
        });

        document.addEventListener('DOMContentLoaded', () => {
            playerId = localStorage.getItem('playerId');
            if (!playerId) {
                window.location.href = '/'; // Redirect to login if no player ID
            } else {
                loadGameDataEnhanced(); // Use enhanced version
            }
    });
  </script>
</body>
</html>