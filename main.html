<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Space Tribes: Command & Decisions</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 50%, #2d1b69 100%);
      color: #ffffff;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      padding: 20px;
      font-size: 1.1rem;
    }
    
    h1 {
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      font-size: 3rem;
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    .logo-container {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .game-logo {
      max-width: 400px;
      width: 100%;
      height: auto;
      filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.3));
      animation: logoGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes logoGlow {
      from { filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.3)); }
      to { filter: drop-shadow(0 0 30px rgba(255, 0, 255, 0.5)); }
    }
    
    @keyframes glow {
      from { text-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
      to { text-shadow: 0 0 30px rgba(255, 0, 255, 0.5); }
    }
    
    h2 {
      font-family: 'Orbitron', monospace;
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #ffff00;
    }
    
    h3 {
      font-size: 1.3rem;
      color: #00ffff;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .player-header {
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 1.2rem;
    }
    
    .tribe-header {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      color: #00ffff;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #playerIcon {
      font-size: 3rem;
      margin-right: 15px;
      filter: drop-shadow(0 0 15px currentColor);
    }
    
    .game-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      .game-grid {
        grid-template-columns: 1fr;
      }
      
      /* Mobile optimizations for iPhone */
      body {
        padding: 10px;
        font-size: 1rem;
      }
      
      h1 {
        font-size: 2rem;
        margin-bottom: 15px;
      }
      
      .game-logo {
        max-width: 280px;
      }
      
      .tribe-header {
        font-size: 1.5rem;
        padding: 10px;
      }
      
      #playerIcon {
        font-size: 2rem;
        margin-right: 10px;
      }
      
      .player-header {
        padding: 10px;
        font-size: 1rem;
      }
      
      .material-row {
        padding: 10px 15px;
        margin: 8px 0;
      }
      
      .material-icon {
        font-size: 1.5rem;
        margin-right: 8px;
      }
      
      .sell-controls {
        gap: 6px;
      }
      
      .sell-controls button {
        width: 32px;
        height: 32px;
        font-size: 1.3rem;
      }
      
      .count-display {
        padding: 6px 10px;
        font-size: 1rem;
        min-width: 40px;
      }
      
      section, .decision-section {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      h2 {
        font-size: 1.4rem;
        margin-bottom: 10px;
      }
      
      .submit-btn {
        padding: 12px 20px;
        font-size: 1rem;
        margin: 5px;
      }
      
      .player-status-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
      }
      
      .player-status {
        padding: 6px 8px;
        font-size: 0.8rem;
      }
      
      table {
        font-size: 0.9rem;
      }
      
      th, td {
        padding: 6px 8px;
      }
    }
    
    section, .decision-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .robot-fleet {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .robots-container {
      display: flex;
      justify-content: center;
      flex-wrap: nowrap;
      gap: 4px;
      margin: 15px 0;
    }
    
    .robot {
      font-size: 1.5rem;
      transition: all 0.3s ease;
      cursor: default;
      filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.5));
    }
    
    .robot.assigned {
      filter: grayscale(100%) brightness(0.3);
      transform: scale(0.8);
    }
    
    .robot.available {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .material-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .material-row:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }
    
    .material-icon {
      font-size: 1.8rem;
      filter: drop-shadow(0 0 10px currentColor);
      margin-right: 10px;
    }
    
    .material-info {
      display: flex;
      align-items: center;
      flex: 1;
    }
    
    .sell-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sell-controls button {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      font-size: 1.6rem;
      font-weight: bold;
      background: linear-gradient(135deg, #00ffff, #00ccff);
      color: #222;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    
    .sell-controls button:hover {
      background: linear-gradient(135deg, #ff00ff, #00ffff);
      color: #fff;
    }
    
    .sell-controls button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    .count-display {
      background: rgba(0, 255, 255, 0.2);
      border: 2px solid rgba(0, 255, 255, 0.5);
      border-radius: 8px;
      padding: 8px 15px;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      font-size: 1.2rem;
      color: #00ffff;
      min-width: 50px;
      text-align: center;
    }
    
    .submit-btn, .process-btn {
      padding: 15px 30px;
      font-size: 1.2rem;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      display: inline-block;
    }
    
    .submit-btn {
      background: linear-gradient(135deg, #00ff00, #00cc00);
      color: #000;
    }
    
    .process-btn {
      background: linear-gradient(135deg, #ff8800, #cc6600);
      color: #fff;
    }
    
    .submit-btn:hover, .process-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .message {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1rem;
    }
    
    .message.success {
      background: rgba(0, 255, 0, 0.1);
      border: 2px solid rgba(0, 255, 0, 0.3);
      color: #00ff00;
    }
    
    .message.error {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid rgba(255, 0, 0, 0.3);
      color: #ff6666;
    }
    
    .fade-in {
      animation: fadeIn 1s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    th {
      background: rgba(255, 255, 255, 0.1);
      color: #00ffff;
      font-family: 'Orbitron', monospace;
    }
    
    ul {
      list-style: none;
      padding: 0;
    }
    
    li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .raid-section {
      background: rgba(255, 0, 0, 0.05);
      border: 2px solid rgba(255, 0, 0, 0.3);
    }
    
    select, .raid-target {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-family: 'Space Mono', monospace;
      margin: 10px 0;
    }
    
    .radio-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }
    
    .radio-option:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .button-group {
      text-align: center;
      margin: 30px 0;
    }
    
    .protected-indicator {
      font-size: 0.8rem;
      color: #ffff00;
      margin-left: 10px;
    }

    .market-summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-family: 'Space Mono', monospace;
    }
    
    .market-summary-table th, .market-summary-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .market-summary-table th {
      background: rgba(255, 255, 255, 0.1);
      color: #00ffff;
      font-family: 'Orbitron', monospace;
    }

    .market-summary-table tfoot tr {
      border-top: 2px solid rgba(0, 255, 255, 0.5);
      font-weight: bold;
    }

    .total-earned {
      color: #00ff00;
    }

    .total-credits {
      color: #ffff00;
      font-size: 1.1rem;
    }

    .no-sales {
      text-align: center;
      font-style: italic;
      color: #888;
      padding: 20px;
    }

    .admin-section {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
      display: none; /* Hide by default */
    }

    .admin-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      align-items: center;
    }

    .admin-btn {
      padding: 8px 15px;
      font-size: 0.9rem;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #ff4444, #cc0000);
      color: #fff;
    }

    .admin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .reset-btn {
      background: linear-gradient(135deg, #ff8800, #cc4400);
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .dice-section {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 255, 0, 0.05);
      border: 2px solid rgba(0, 255, 0, 0.3);
      border-radius: 10px;
      text-align: center;
    }

    .dice-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .dice {
      width: 60px;
      height: 60px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .dice.rolling {
      animation: roll 0.5s ease-in-out;
    }

    @keyframes roll {
      0% { transform: rotateX(0deg) rotateY(0deg); }
      50% { transform: rotateX(180deg) rotateY(180deg); }
      100% { transform: rotateX(360deg) rotateY(360deg); }
    }

    .roll-btn {
      padding: 10px 20px;
      font-size: 1rem;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: linear-gradient(135deg, #00ff00, #00cc00);
      color: #000;
      transition: all 0.3s ease;
    }

    .roll-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
    }

    .roll-btn:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
      transform: none;
    }

    .roll-result {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 10px;
    }

    .roll-result.success {
      color: #00ff00;
    }

    .roll-result.failure {
      color: #ff6666;
    }

    .raid-controls {
      display: flex;
      gap: 20px;
      align-items: end;
      margin: 20px 0;
    }

    .raid-dropdown {
      flex: 1;
    }

    .raid-dropdown label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #ffff00;
    }

    .raid-dropdown select {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-family: 'Space Mono', monospace;
      font-size: 1rem;
    }

    .player-status-header {
      background: rgba(255, 255, 0, 0.1);
      border: 2px solid rgba(255, 255, 0, 0.3);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      font-family: 'Orbitron', monospace;
      text-align: center;
    }

    .player-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
      justify-items: center;
    }

    .player-status {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
      font-weight: bold;
    }

    .status-never { 
      background: rgba(128, 128, 128, 0.2); 
      color: #aaa; 
    }

    .status-waiting { 
      background: rgba(255, 165, 0, 0.2); 
      color: #ffaa00; 
    }

    .status-submitted { 
      background: rgba(0, 255, 0, 0.2); 
      color: #00ff00; 
    }
    /* ...existing code... */
  </style>
</head>
<body>
  <div class="container fade-in">
    <div class="logo-container">
      <img src="spacetribeslogo2.png" alt="Space Tribes" class="game-logo">
    </div>
    <div class="tribe-header">
      <span id="playerIcon">🐻</span>
      <span id="tribeName">Tribe of Endor</span>
    </div>

    <div class="player-header">
      <div>Day <span id="currentDay">?</span> | Player: <span id="playerName">Loading...</span> | Credits: $<span id="credits">0</span></div>
      <div style="margin-top: 10px;">Available Robots: <span id="robotCount">10</span>/10</div>
    </div>

    <div class="player-status-header">
      <h3>📊 Player Status - Day <span id="statusDay">?</span></h3>
      <div class="player-status-grid" id="playerStatusGrid">
      </div>
    </div>

    <div class="game-grid">
      <!-- Left Column: Dashboard -->
      <div>
        <section>
          <h2>📦 Your Stockpile</h2>
          <table id="stockpileTable">
            <thead>
              <tr><th>Resource</th><th>Available</th><th>Raided</th><th>Total</th></tr>
            </thead>
            <tbody id="stockpile"></tbody>
          </table>
        </section>

        <section>
          <h2>⛏️ Last Mining Results</h2>
          <table>
            <thead>
              <tr><th>Resource</th><th>Mined</th></tr>
            </thead>
            <tbody id="lastMining"></tbody>
          </table>
        </section>

        <section>
          <h2>💰 Last Night's Sales Results</h2>
          <div id="marketSummary">
            <table class="market-summary-table">
              <thead>
                <tr>
                  <th>Resource</th>
                  <th>Sold</th>
                  <th>Price</th>
                  <th>Earned</th>
                </tr>
              </thead>
              <tbody id="salesSummary">
                <!-- Sales data will be populated here -->
              </tbody>
              <tfoot>
                <tr class="total-earned">
                  <td>TOTAL EARNED:</td>
                  <td colspan="2"></td>
                  <td>$<span id="totalEarned">0</span></td>
                </tr>
                <tr class="total-credits">
                  <td>TOTAL CREDITS:</td>
                  <td colspan="2"></td>
                  <td>$<span id="totalCredits">0</span></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div id="noSalesMessage" class="no-sales" style="display: none;">
            No sales made last night
          </div>
        </section>

        <section>
          <h2>🌍 Total Colony Mining</h2>
          <ul id="colonyMining"></ul>
        </section>
      </div>

      <!-- Right Column: News and Players -->
      <div>
        <section>
          <h2>📰 News Board</h2>
          <ul id="newsBoard"></ul>
        </section>

        <section>
          <h2>🏆 Leaderboard</h2>
          <ul id="leaderboard"></ul>
        </section>

        <section>
          <h2>👥 Player Stockpiles</h2>
          <table>
            <thead>
              <tr><th>Player</th><th>💎</th><th>🔻</th><th>🔷</th><th>🌱</th></tr>
            </thead>
            <tbody id="playersStockpiles"></tbody>
          </table>
        </section>
      </div>
    </div>

    <!-- Mining Decisions -->
    <div class="decision-section">
      <h2>⛏️ Deploy Mining Robots</h2>
      <p>Assign your mining robots to extract resources. Each robot mines 1 unit per turn.</p>
      
      <!-- Compact Robot Display -->
      <div class="robots-container" id="robotsContainer"></div>
      
      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">💎</span>
          <span>$20</span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustEffort('whiteDiamonds', -1)">➖</button>
          <span class="count-display" id="effortCount-whiteDiamonds">0</span>
          <button type="button" onclick="adjustEffort('whiteDiamonds', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔻</span>
          <span>$15</span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustEffort('redRubies', -1)">➖</button>
          <span class="count-display" id="effortCount-redRubies">0</span>
          <button type="button" onclick="adjustEffort('redRubies', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔷</span>
          <span>$12</span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustEffort('blueGems', -1)">➖</button>
          <span class="count-display" id="effortCount-blueGems">0</span>
          <button type="button" onclick="adjustEffort('blueGems', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🌱</span>
          <span>$10</span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustEffort('greenPoison', -1)">➖</button>
          <span class="count-display" id="effortCount-greenPoison">0</span>
          <button type="button" onclick="adjustEffort('greenPoison', 1)">➕</button>
        </div>
      </div>
    </div>

    <!-- Selling Decisions -->
    <div class="decision-section">
      <h2>💰 Sell Resources (15 Max Each)</h2>
      <p>Sell your available resources at <strong>NEW market prices</strong> calculated from tonight's mining output. <strong>Maximum 15 per resource per day!</strong> Raided resources cannot be sold until tomorrow!</p>
      <p style="font-size: 0.9rem; color: #ffaa00; margin-top: 10px;"><strong>📊 Price Formula:</strong> Higher total mining = Lower prices | Lower total mining = Higher prices. Your sale prices are determined by how much EVERYONE mines tonight, not current prices!</p>
      
      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">💎</span>
          <span>💎 Qty: <span id="available-whiteDiamonds">0</span></span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustSell('whiteDiamonds', -1)">➖</button>
          <span class="count-display" id="sellCount-whiteDiamonds">0</span>
          <button type="button" onclick="adjustSell('whiteDiamonds', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔻</span>
          <span>🔻 Qty: <span id="available-redRubies">0</span></span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustSell('redRubies', -1)">➖</button>
          <span class="count-display" id="sellCount-redRubies">0</span>
          <button type="button" onclick="adjustSell('redRubies', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🔷</span>
          <span>🔷 Qty: <span id="available-blueGems">0</span></span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustSell('blueGems', -1)">➖</button>
          <span class="count-display" id="sellCount-blueGems">0</span>
          <button type="button" onclick="adjustSell('blueGems', 1)">➕</button>
        </div>
      </div>

      <div class="material-row">
        <div class="material-info">
          <span class="material-icon">🌱</span>
          <span>🌱 Qty: <span id="available-greenPoison">0</span></span>
        </div>
        <div class="sell-controls">
          <button type="button" onclick="adjustSell('greenPoison', -1)">➖</button>
          <span class="count-display" id="sellCount-greenPoison">0</span>
          <button type="button" onclick="adjustSell('greenPoison', 1)">➕</button>
        </div>
      </div>
    </div>

    <!-- Raid Decisions -->
    <div class="decision-section raid-section">
      <h2>⚔️ Raid Operations</h2>
      <p>Spend 2 Green Poison to attempt stealing 2 resources from another player. Your stolen resources are protected until tomorrow!</p>
      
      <div class="raid-controls">
        <div class="raid-dropdown">
          <label>Choose Target:</label>
          <select id="raidTarget">
            <option value="none">None</option>
          </select>
        </div>
        
        <div class="raid-dropdown">
          <label>Choose Resource:</label>
          <select id="raidMaterial">
            <option value="">None</option>
            <option value="whiteDiamonds">💎 White Diamonds</option>
            <option value="redRubies">🔻 Red Rubies</option>
            <option value="blueGems">🔷 Blue Gems</option>
            <option value="greenPoison">🌱 Green Poison</option>
          </select>
        </div>
      </div>
      
      <div class="dice-section" id="diceSection" style="display: none;">
        <h4 style="color: #00ffff; margin-bottom: 10px;">🎲 Roll 2+ to Raid</h4>
        <div class="dice-container">
          <div class="dice" id="dice">?</div>
          <button class="roll-btn" id="rollBtn" onclick="rollDice()">Roll</button>
          <div class="roll-result" id="rollResult"></div>
        </div>
      </div>
    </div>

    <div class="button-group">
      <button class="submit-btn" id="submitBtn" onclick="submitDecisions()">🚀 SUBMIT DECISIONS FOR DAY ? 🚀</button>
    </div>

    <div id="message" class="message"></div>
    
    <!-- Admin Controls -->
    <div class="admin-section">
      <div class="admin-buttons">
        <button class="admin-btn" onclick="processDay()">⚠️ ADMIN: PROCESS NEXT DAY</button>
        <button class="admin-btn reset-btn" onclick="resetGame()">💀 RESET</button>
      </div>
    </div>
  </div>

  <script>
    // Game state
    let gameData = {};
    const robotAssignments = {
      whiteDiamonds: 0,
      redRubies: 0,
      blueGems: 0,
      greenPoison: 0
    };
    const sellAssignments = {
      whiteDiamonds: 0,
      redRubies: 0,
      blueGems: 0,
      greenPoison: 0
    };

    // Get player ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const playerId = urlParams.get('playerId');

    if (!playerId) {
      window.location.href = '/';
    }

    // Initialize robots display
    function initializeRobots() {
      const container = document.getElementById('robotsContainer');
      container.innerHTML = '';
      for (let i = 0; i < 10; i++) {
        const robot = document.createElement('div');
        robot.className = 'robot available';
        robot.innerHTML = '🤖';
        robot.id = `robot-${i}`;
        container.appendChild(robot);
      }
    }

    // Update robot visual states
    function updateRobotDisplay() {
      const robots = document.querySelectorAll('.robot');
      const totalAssigned = Object.values(robotAssignments).reduce((a, b) => a + b, 0);
      
      robots.forEach((robot, index) => {
        if (index < totalAssigned) {
          robot.className = 'robot assigned';
        } else {
          robot.className = 'robot available';
        }
      });

      const robotCountEl = document.getElementById('robotCount');
if (robotCountEl) robotCountEl.textContent = 10 - totalAssigned;
    }

    // Update button states
    function updateButtonStates() {
      const totalAssigned = Object.values(robotAssignments).reduce((a, b) => a + b, 0);
      
      Object.keys(robotAssignments).forEach(resource => {
        const effortMinus = document.querySelector(`[onclick="adjustEffort('${resource}', -1)"]`);
        const effortPlus = document.querySelector(`[onclick="adjustEffort('${resource}', 1)"]`);
        const sellMinus = document.querySelector(`[onclick="adjustSell('${resource}', -1)"]`);
        const sellPlus = document.querySelector(`[onclick="adjustSell('${resource}', 1)"]`);
        
        if (effortMinus) effortMinus.disabled = robotAssignments[resource] === 0;
        if (effortPlus) effortPlus.disabled = totalAssigned >= 10;
        
        if (sellMinus) sellMinus.disabled = sellAssignments[resource] === 0;
        if (sellPlus) {
          const available = gameData.stockpiles ? (gameData.stockpiles[resource] || 0) : 0;
          const maxSell = Math.min(available, 15);
          sellPlus.disabled = sellAssignments[resource] >= maxSell;
        }
      });
    }

    // Adjust robot assignments
    function adjustEffort(resource, change) {
      if (typeof trackUserActivity === 'function') trackUserActivity();
      
      const totalAssigned = Object.values(robotAssignments).reduce((a, b) => a + b, 0);
      
      if (change > 0 && totalAssigned >= 10) return;
      if (change < 0 && robotAssignments[resource] === 0) return;
      
      robotAssignments[resource] = Math.max(0, robotAssignments[resource] + change);
      document.getElementById(`effortCount-${resource}`).textContent = robotAssignments[resource];
      
      updateRobotDisplay();
    }

    // Adjust sell assignments
    function adjustSell(resource, change) {
      if (typeof trackUserActivity === 'function') trackUserActivity();
      
      const available = gameData.stockpiles ? (gameData.stockpiles[resource] || 0) : 0;
      const maxSell = Math.min(available, 15); // Can't sell more than 15 OR available amount
      
      if (change > 0 && sellAssignments[resource] >= maxSell) return;
      if (change < 0 && sellAssignments[resource] === 0) return;
      
      sellAssignments[resource] = Math.max(0, Math.min(sellAssignments[resource] + change, maxSell));
      document.getElementById(`sellCount-${resource}`).textContent = sellAssignments[resource];
      
      updateButtonStates();
    }

    // Load game data
    function loadGameData() {
      fetch(`/game-data/${playerId}`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (data.error) {
            // If player not found, redirect to login
            if (data.error === 'Player not found') {
              window.location.href = '/';
              return;
            }
            throw new Error(data.error);
          }
          gameData = data;
          updateUI();
        })
        .catch(err => {
          // If it's a player not found error, redirect instead of showing error
          if (err.message === 'Player not found') {
            window.location.href = '/';
            return;
          }
          showMessage(`Failed to load game data: ${err.message}`, 'error');
        });
    }

    // Update UI with game data
    function updateUI() {
      try {
        // Ensure all required properties exist
        if (!gameData.stockpiles) gameData.stockpiles = {};
        if (!gameData.protectedResources) gameData.protectedResources = {};
        if (!gameData.totalStockpiles) gameData.totalStockpiles = {};
        if (!gameData.lastEfforts) gameData.lastEfforts = {};
        if (!gameData.prices) gameData.prices = {};
        if (!gameData.needs) gameData.needs = {};
        if (!gameData.lastSupply) gameData.lastSupply = {};
        if (!gameData.efforts) gameData.efforts = {};
        if (!gameData.sales) gameData.sales = {};
        if (!gameData.leaderboard) gameData.leaderboard = [];
        if (!gameData.news) gameData.news = [];
        if (!gameData.lastNightSales) gameData.lastNightSales = [];

        // Header info
        document.getElementById('currentDay').textContent = gameData.currentDay || '?';
        document.getElementById('playerName').textContent = gameData.playerName || 'Unknown';
        document.getElementById('credits').textContent = gameData.credits || 0;

        // Update submit button based on submission status
        const submitBtn = document.getElementById('submitBtn');
        const currentDay = gameData.currentDay || '?';
        if (gameData.hasSubmitted) {
          submitBtn.textContent = `✅ DONE FOR DAY ${currentDay} ✅`;
          submitBtn.disabled = false; // Still allow updates
          submitBtn.style.background = 'linear-gradient(135deg, #666, #888)';
        } else {
          submitBtn.textContent = `🚀 SUBMIT DECISIONS FOR DAY ${currentDay} 🚀`;
          submitBtn.disabled = false;
          submitBtn.style.background = 'linear-gradient(135deg, #00ff00, #00cc00)';
        }
        
        // Update tribe display
        const iconMap = {
          'Dave': '🐻',
          'Silas': '🦎', 
          'Chris': '🔆',
          'Brian': '🧠',
          'Joel': '🛡️',
          'Curtis': '💧'
        };
        document.getElementById('playerIcon').textContent = iconMap[gameData.playerName] || '🚀';
        document.getElementById('tribeName').textContent = gameData.playerRace || 'Unknown Tribe';

        // Load current decisions - BUT ONLY if user hasn't made changes
        const hasUserChanges = Object.keys(robotAssignments).some(resource => 
          (robotAssignments[resource] !== (gameData.efforts[resource] || 0)) ||
          (sellAssignments[resource] !== (gameData.sales[resource] || 0))
        );
        
        if (!hasUserChanges) {
          Object.keys(robotAssignments).forEach(resource => {
            robotAssignments[resource] = gameData.efforts[resource] || 0;
            sellAssignments[resource] = gameData.sales[resource] || 0;
            
            document.getElementById(`effortCount-${resource}`).textContent = robotAssignments[resource];
            document.getElementById(`sellCount-${resource}`).textContent = sellAssignments[resource];
          });
        }

        updateRobotDisplay();

        // Stockpile table
        const stockpileBody = document.getElementById('stockpile');
        stockpileBody.innerHTML = '';
        const resources = ['whiteDiamonds', 'redRubies', 'blueGems', 'greenPoison'];
        const resourceNames = ['💎 White Diamonds', '🔻 Red Rubies', '🔷 Blue Gems', '🌱 Green Poison'];
        
        resources.forEach((resource, i) => {
          const available = gameData.stockpiles[resource] || 0;
          const protected = gameData.protectedResources[resource] || 0;
          const total = gameData.totalStockpiles[resource] || 0;
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${resourceNames[i]}</td>
            <td>${available}</td>
            <td>${protected > 0 ? `<span style="color: #ffff00">${protected}</span>` : '0'}</td>
            <td>${total}</td>
          `;
          stockpileBody.appendChild(row);
          
          // Update available amounts for selling
          const availableSpan = document.getElementById(`available-${resource}`);
          if (availableSpan) availableSpan.textContent = available;
        });

        // Last mining results
        const lastMiningBody = document.getElementById('lastMining');
        lastMiningBody.innerHTML = '';
        resources.forEach((resource, i) => {
          const mined = gameData.lastEfforts[resource] || 0;
          const row = document.createElement('tr');
          row.innerHTML = `<td>${resourceNames[i]}</td><td>${mined}</td>`;
          lastMiningBody.appendChild(row);
        });

        try {
          updateMarketSummary();
        } catch (error) {
        }

        // Total Colony Mining
        try {
          const colonyMiningList = document.getElementById('colonyMining');
          if (!colonyMiningList) {
            return;
          }
          colonyMiningList.innerHTML = '';
          const resources = ['whiteDiamonds', 'redRubies', 'blueGems', 'greenPoison'];
          const resourceIcons = ['💎', '🔻', '🔷', '🌱'];

          resources.forEach((resource, i) => {
            const totalMined = gameData.lastSupply[resource] || 0;
            const li = document.createElement('li');
            li.innerHTML = `${resourceIcons[i]} ${totalMined}/15`;
            colonyMiningList.appendChild(li);
          });
        } catch (error) {
          console.error('Error in colony mining section:', error);
        }

        // News board
        const newsBoard = document.getElementById('newsBoard');
        newsBoard.innerHTML = '';
        if (gameData.news && gameData.news.length > 0) {
          gameData.news.slice(-10).forEach(newsItem => {
            const li = document.createElement('li');
            li.textContent = newsItem;
            newsBoard.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = 'No news yet...';
          li.style.fontStyle = 'italic';
          newsBoard.appendChild(li);
        }

        // Leaderboard
        const leaderboard = document.getElementById('leaderboard');
        leaderboard.innerHTML = '';
        gameData.leaderboard.forEach((player, index) => {
          const li = document.createElement('li');
          li.innerHTML = `${index + 1}. ${player.name}`;
          leaderboard.appendChild(li);
        });

        // Player stockpiles
        const playersBody = document.getElementById('playersStockpiles');
        playersBody.innerHTML = '';
        gameData.leaderboard.forEach(player => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${player.name}</td>
            <td>${player.stockpiles.whiteDiamonds || 0}</td>
            <td>${player.stockpiles.redRubies || 0}</td>
            <td>${player.stockpiles.blueGems || 0}</td>
            <td>${player.stockpiles.greenPoison || 0}</td>
          `;
          playersBody.appendChild(row);
        });

        // Raid targets
        const raidTarget = document.getElementById('raidTarget');
        raidTarget.innerHTML = '<option value="none">None</option>';
        gameData.leaderboard.forEach(player => {
          if (player.name !== gameData.playerName) {
            const option = document.createElement('option');
            option.value = player.name;
            option.textContent = player.name;
            if (gameData.raidTarget === player.name) {
              option.selected = true;
            }
            raidTarget.appendChild(option);
          }
        });

        // Set raid material
        if (gameData.raidMaterial) {
          document.getElementById('raidMaterial').value = gameData.raidMaterial;
        } else {
          document.getElementById('raidMaterial').value = '';
        }
        
        // Show admin section only for Dave
        const adminSection = document.querySelector('.admin-section');
        if (adminSection) {
          if (gameData.playerName === 'Dave') {
            adminSection.style.display = 'block';
          } else {
            adminSection.style.display = 'none';
          }
        }
        
        updatePlayerStatus();
      } catch (error) {
        console.error('Error in updateUI:', error);
        showMessage('Error updating interface', 'error');
      }
    }

    // Update player status display
    function updatePlayerStatus() {
      const statusGrid = document.getElementById('playerStatusGrid');
      const statusDay = document.getElementById('statusDay');
      
      if (!statusGrid) return;
      
      statusDay.textContent = gameData.currentDay || '?';
      statusGrid.innerHTML = '';
      
      // All possible commanders - ALWAYS show these 6 names
      const allCommanders = ['Dave', 'Silas', 'Chris', 'Brian', 'Joel', 'Curtis'];
      
      allCommanders.forEach(commanderName => {
        const statusDiv = document.createElement('div');
        statusDiv.className = 'player-status';
        
        // Find this player in the leaderboard (if they've logged in)
        const player = gameData.leaderboard ? gameData.leaderboard.find(p => p.name === commanderName) : null;
        
        if (!player) {
          // Player has never logged in
          statusDiv.classList.add('status-never');
          statusDiv.innerHTML = `${commanderName}<br>Never Started`;
        } else if (player.hasSubmitted === true) {
          // Player has submitted for current day
          statusDiv.classList.add('status-submitted');
          statusDiv.innerHTML = `${commanderName}<br>✅ Day ${gameData.currentDay} Complete`;
        } else {
          // Player has logged in but waiting for submission
          statusDiv.classList.add('status-waiting');
          statusDiv.innerHTML = `${commanderName}<br>⏳ Waiting for Day ${gameData.currentDay}`;
        }
        
        statusGrid.appendChild(statusDiv);
      });
    }

    // Submit decisions
    function submitDecisions() {
      const totalRobots = Object.values(robotAssignments).reduce((a, b) => a + b, 0);
      
      if (totalRobots === 0) {
        showMessage('You must assign at least one mining robot!', 'error');
        return;
      }

      const raidTarget = document.getElementById('raidTarget').value;
      const raidMaterial = document.getElementById('raidMaterial').value || null;

      // Validate raid selection
      if (raidTarget !== 'none' && !raidMaterial) {
        showMessage('⚠️ You selected a raid target but no resource! Please choose which resource to steal.', 'error');
        return;
      }
      
      // Check dice roll for raids
      if (raidTarget !== 'none' && raidMaterial) {
        if (!hasRolled) {
          showMessage('⚠️ You must roll the dice before submitting a raid!', 'error');
          return;
        }
        if (rollResult < 2) {
          showMessage('💀 Your dice roll failed! Raid will not be attempted.', 'error');
          // Set raid to none since it failed
          document.getElementById('raidTarget').value = 'none';
          document.getElementById('raidMaterial').value = '';
          updateDiceSection();
        }
      }

      const decisions = {
        playerId,
        efforts: robotAssignments,
        sales: sellAssignments,
        raidTarget: rollResult >= 2 ? (raidTarget === 'none' ? null : raidTarget) : null,
        raidMaterial: rollResult >= 2 ? raidMaterial : null
      };

      fetch('/submit-decisions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(decisions)
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message || 'Decisions submitted successfully!', 'success');
          // Immediately update button to show "DONE"
          const submitBtn = document.getElementById('submitBtn');
          const currentDay = gameData.currentDay || '?';
          submitBtn.textContent = `✅ DONE FOR DAY ${currentDay} ✅`;
          submitBtn.style.background = 'linear-gradient(135deg, #666, #888)';
          loadGameData(); // Refresh to show submitted state
        }
      })
      .catch(err => {
        showMessage('Failed to submit decisions', 'error');
      });
    }

    // Process day
    function processDay() {
      showMessage('Processing day... This may take a moment.', 'success');
      
      fetch('/process-day', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message || 'Day processed successfully!', 'success');
          // Reset assignments for new day
          Object.keys(robotAssignments).forEach(resource => {
            robotAssignments[resource] = 0;
            sellAssignments[resource] = 0;
            document.getElementById(`effortCount-${resource}`).textContent = '0';
            document.getElementById(`sellCount-${resource}`).textContent = '0';
          });
          // Clear raid selections
          document.getElementById('raidTarget').value = 'none';
          document.getElementById('raidMaterial').value = '';
          updateRobotDisplay();
          loadGameData(); // Refresh all data
        }
      })
      .catch(err => {
        console.error('Process day error:', err);
        showMessage('Failed to process day', 'error');
      });
    }

    // Reset game function
    function resetGame() {
      if (!confirm('⚠️ ADMIN: Are you sure you want to reset the entire game? This will delete all player data and start over!')) {
        return;
      }
      
      if (!confirm('🚨 FINAL WARNING: This action cannot be undone. Reset game?')) {
        return;
      }
      
      showMessage('Resetting game... This may take a moment.', 'success');
      
      fetch('/reset-game', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            showMessage(data.error, 'error');
          } else {
            showMessage('Game reset successfully! Redirecting to login...', 'success');
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
        })
        .catch(err => {
          showMessage('Failed to reset game', 'error');
        });
    }

    // Show message
    function showMessage(text, type = 'success') {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        messageEl.textContent = '';
        messageEl.className = 'message';
      }, 5000);
    }

    // Update market summary
    function updateMarketSummary() {
      try {
        const salesSummaryBody = document.getElementById('salesSummary');
        const noSalesMessage = document.getElementById('noSalesMessage');
        const marketSummary = document.getElementById('marketSummary');
        
        if (!salesSummaryBody || !noSalesMessage || !marketSummary) {
          return;
        }
        
        salesSummaryBody.innerHTML = '';
        
        const resourceIcons = {
          'whiteDiamonds': '💎',
          'redRubies': '🔻', 
          'blueGems': '🔷',
          'greenPoison': '🌱'
        };
        
        if (gameData.lastNightSales && gameData.lastNightSales.length > 0) {
          marketSummary.style.display = 'block';
          noSalesMessage.style.display = 'none';
          
          let totalEarned = 0;
          
          gameData.lastNightSales.forEach(sale => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${resourceIcons[sale.resource] || '?'}</td>
              <td>${sale.quantity || 0}</td>
              <td>$${sale.price_per_unit || 0}</td>
              <td style="color: #00ff00; font-weight: bold;">$${sale.total_earned || 0}</td>
            `;
            salesSummaryBody.appendChild(row);
            totalEarned += (sale.total_earned || 0);
          });
          
          document.getElementById('totalEarned').textContent = totalEarned;
        } else {
          marketSummary.style.display = 'none';
          noSalesMessage.style.display = 'block';
          document.getElementById('totalEarned').textContent = '0';
        }
        
        document.getElementById('totalCredits').textContent = gameData.credits || 0;
        
      } catch (error) {
      }
    }

    // Dice rolling variables
    let hasRolled = false;
    let rollResult = null;

    // Show/hide dice section based on raid selection
    function updateDiceSection() {
      const raidTarget = document.getElementById('raidTarget').value;
      const raidMaterial = document.getElementById('raidMaterial').value;
      const diceSection = document.getElementById('diceSection');
      
      if (raidTarget !== 'none' && raidMaterial) {
        // Check if player has enough Green Poison
        const availablePoison = gameData.stockpiles ? (gameData.stockpiles.greenPoison || 0) : 0;
        
        if (availablePoison >= 2) {
          diceSection.style.display = 'block';
        } else {
          diceSection.style.display = 'none';
          showMessage('⚠️ You need at least 2 🌱 Green Poison to attempt a raid!', 'error');
          // Reset raid selections
          document.getElementById('raidTarget').value = 'none';
          document.getElementById('raidMaterial').value = '';
        }
      } else {
        diceSection.style.display = 'none';
        resetDice();
      }
    }

    // Reset dice for new day
    function resetDice() {
      hasRolled = false;
      rollResult = null;
      document.getElementById('dice').textContent = '?';
      document.getElementById('rollBtn').disabled = false;
      document.getElementById('rollResult').textContent = '';
    }

    // Roll the dice
    function rollDice() {
      if (hasRolled) return;
      
      // Double-check poison requirement
      const availablePoison = gameData.stockpiles ? (gameData.stockpiles.greenPoison || 0) : 0;
      if (availablePoison < 2) {
        showMessage('⚠️ You need at least 2 🌱 Green Poison to raid!', 'error');
        document.getElementById('raidTarget').value = 'none';
        document.getElementById('raidMaterial').value = '';
        updateDiceSection();
        return;
      }
      
      const dice = document.getElementById('dice');
      const rollBtn = document.getElementById('rollBtn');
      const resultDiv = document.getElementById('rollResult');
      
      // Add rolling animation
      dice.classList.add('rolling');
      rollBtn.disabled = true;
      
      // Simulate rolling
      setTimeout(() => {
        const roll = Math.floor(Math.random() * 6) + 1;
        rollResult = roll;
        hasRolled = true;
        
        dice.textContent = roll;
        dice.classList.remove('rolling');
        
        if (roll >= 2) {
          resultDiv.textContent = '✅ Successful Raid!';
          resultDiv.className = 'roll-result success';
        } else {
          resultDiv.textContent = '❌ Raid Failed!';
          resultDiv.className = 'roll-result failure';
        }
      }, 500);
    }

    // Track user activity to pause auto-refresh
    let lastUserActivity = Date.now();
    let userIsActive = false;
    
    // Update activity tracker
    function trackUserActivity() {
      lastUserActivity = Date.now();
      userIsActive = true;
      // Clear activity flag after 10 seconds of no interaction
      setTimeout(() => {
        if (Date.now() - lastUserActivity >= 10000) {
          userIsActive = false;
        }
      }, 10000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initializeRobots();
      loadGameData();
      
      // Track user interactions
      document.addEventListener('click', trackUserActivity);
      document.addEventListener('input', trackUserActivity);
      document.addEventListener('change', trackUserActivity);
      
      // Smart auto-refresh - only when user is not actively making changes
      setInterval(() => {
        if (!userIsActive) {
          loadGameData();
        }
      }, 30000);

      document.getElementById('raidTarget').addEventListener('change', updateDiceSection);
      document.getElementById('raidMaterial').addEventListener('change', updateDiceSection);
    });
  </script>
</body>
</html>